<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ikemap - Navegaci√≥n Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  height: 100%;
  font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', sans-serif;
  overflow: hidden;
}

/* LOADING SCREEN */
#loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10000;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}

#loading-screen.hidden {
  opacity: 0;
  visibility: hidden;
}

.loader {
  position: relative;
  width: 80px;
  height: 80px;
}

.loader::before,
.loader::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  border: 4px solid transparent;
  border-top-color: white;
  animation: spin 1s linear infinite;
}

.loader::before {
  width: 80px;
  height: 80px;
}

.loader::after {
  width: 60px;
  height: 60px;
  top: 10px;
  left: 10px;
  animation-duration: 0.7s;
  animation-direction: reverse;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  color: white;
  font-size: 24px;
  font-weight: 700;
  margin-top: 30px;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

/* LOGIN MODAL */
#login-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

#login-modal.active {
  display: flex;
}

.login-box {
  background: white;
  padding: 40px;
  border-radius: 24px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideInUp 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideInUp {
  from {
    transform: translateY(50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.login-box h2 {
  margin: 0 0 10px 0;
  font-size: 28px;
  text-align: center;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.login-box p {
  text-align: center;
  color: #666;
  margin-bottom: 30px;
  font-size: 14px;
}

.login-tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 2px solid #e0e0e0;
}

.login-tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  font-weight: 600;
  color: #999;
  transition: all 0.3s ease;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
}

.login-tab.active {
  color: #667eea;
  border-bottom-color: #667eea;
}

.login-content {
  display: none;
}

.login-content.active {
  display: block;
}

.input-group {
  margin-bottom: 16px;
}

.input-group input {
  width: 100%;
  padding: 14px 16px;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
  transition: all 0.3s ease;
}

.input-group input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.btn {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
  transition: all 0.3s ease;
  margin-bottom: 10px;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: #f5f5f5;
  color: #333;
  border: 2px solid #e0e0e0;
}

.btn-secondary:hover {
  background: #e8e8e8;
  border-color: #ccc;
}

.btn-google {
  background: white;
  color: #333;
  border: 2px solid #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.btn-google:hover {
  background: #f5f5f5;
  border-color: #667eea;
}

.divider {
  text-align: center;
  margin: 20px 0;
  color: #999;
  position: relative;
}

.divider::before,
.divider::after {
  content: '';
  position: absolute;
  top: 50%;
  width: 40%;
  height: 1px;
  background: #e0e0e0;
}

.divider::before {
  left: 0;
}

.divider::after {
  right: 0;
}

/* MAP */
#map {
  height: 100%;
  width: 100%;
}

/* BRAND */
.brand {
  position: absolute;
  top: 15px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  text-align: center;
  pointer-events: none;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 32px;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.brand h1 {
  margin: 0;
  font-size: 28px;
  font-weight: 700;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.brand small {
  font-size: 11px;
  color: #666;
  font-weight: 400;
}

/* SEARCH PANEL */
.search-panel {
  position: absolute;
  top: 20px;
  left: 20px;
  width: 380px;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  padding: 20px;
  border-radius: 24px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  z-index: 1000;
}

.search-box {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.search-box input {
  flex: 1;
  padding: 14px 16px;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  font-size: 14px;
  font-family: 'Poppins', sans-serif;
  transition: all 0.3s ease;
}

.search-box input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.search-btn {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.search-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

.quick-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.quick-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: 2px solid #e0e0e0;
  background: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.quick-btn:hover {
  border-color: #667eea;
  color: #667eea;
}

/* LIVE SEARCH RESULTS */
.live-results {
  display: none;
  background: white;
  border-radius: 16px;
  margin-top: 10px;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  animation: slideDown 0.3s ease;
}

.live-results.active {
  display: block;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.live-result-item {
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 12px;
}

.live-result-item:last-child {
  border-bottom: none;
}

.live-result-item:hover {
  background: #f8f9ff;
  padding-left: 20px;
}

.live-result-icon {
  font-size: 20px;
  width: 30px;
  text-align: center;
}

.live-result-info {
  flex: 1;
}

.live-result-name {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.live-result-address {
  font-size: 12px;
  color: #666;
  margin: 2px 0 0 0;
}

.live-results-loading {
  padding: 20px;
  text-align: center;
  color: #999;
  font-size: 13px;
}

.live-results::-webkit-scrollbar {
  width: 6px;
}

.live-results::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.live-results::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 10px;
}

/* RESULTS MODAL - NOW SIDEBAR */
#results-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 9998;
  animation: fadeIn 0.3s ease;
}

#results-modal.active {
  display: block;
}

.results-box {
  position: fixed;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  background: white;
  padding: 30px;
  border-radius: 24px;
  width: 380px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideInLeft 0.4s ease;
}

@keyframes slideInLeft {
  from {
    transform: translateY(-50%) translateX(-400px);
    opacity: 0;
  }
  to {
    transform: translateY(-50%) translateX(0);
    opacity: 1;
  }
}

.results-box h3 {
  margin: 0 0 20px 0;
  font-size: 24px;
  color: #333;
}

.result-item {
  padding: 16px;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.result-item:hover {
  border-color: #667eea;
  background: #f8f9ff;
}

.result-item h4 {
  margin: 0 0 5px 0;
  font-size: 16px;
  color: #333;
}

.result-item p {
  margin: 0;
  font-size: 13px;
  color: #666;
}

.close-modal, .close-btn {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #f0f0f0;
  border: none;
  cursor: pointer;
  font-size: 20px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-modal:hover, .close-btn:hover {
  background: #e0e0e0;
  transform: rotate(90deg);
}

/* PLACE DETAIL - NOW SIDEBAR */
#place-detail-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 9997;
  animation: fadeIn 0.3s ease;
}

#place-detail-modal.active {
  display: block;
}

.place-detail-box {
  position: fixed;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  background: white;
  border-radius: 24px;
  width: 450px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideInLeft 0.4s ease;
}

.close-modal {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.9);
  border: none;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.close-modal:hover {
  background: white;
  transform: rotate(90deg);
}

/* ROUTE PANEL - SIDEBAR */
.route-panel {
  position: fixed;
  left: 20px;
  bottom: 20px;
  width: 380px;
  max-height: 70vh;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  padding: 20px;
  padding-top: 60px;
  border-radius: 24px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
  z-index: 10000;
  display: none;
  animation: slideInUp 0.4s ease;
  overflow-y: auto;
}

.route-panel.active {
  display: block;
}

.route-panel h3 {
  margin: 0 0 20px 0;
  font-size: 22px;
  color: #333;
}

.transport-modes {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  justify-content: center;
}

.transport-btn {
  flex: 1;
  padding: 12px;
  border-radius: 12px;
  border: 2px solid #e0e0e0;
  background: white;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.transport-btn:hover {
  border-color: #667eea;
  transform: translateY(-2px);
}

.transport-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.route-panel .close-btn {
  position: absolute;
  top: 15px;
  right: 15px;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: #f0f0f0;
  border: none;
  cursor: pointer;
  font-size: 18px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.route-panel .close-btn:hover {
  background: #e0e0e0;
  transform: rotate(90deg);
}

#route-info {
  margin-top: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}

#route-steps {
  margin-top: 15px;
  max-height: 250px;
  overflow-y: auto;
  padding-right: 5px;
}

#route-steps::-webkit-scrollbar {
  width: 6px;
}

#route-steps::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

#route-steps::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 10px;
}

/* ROUTE MODAL */
#route-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

#route-modal.active {
  display: flex;
}

.route-box {
  background: white;
  padding: 30px;
  border-radius: 24px;
  width: 90%;
  max-width: 600px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideInUp 0.4s ease;
  position: relative;
}

.route-box h3 {
  margin: 0 0 20px 0;
  font-size: 24px;
  color: #333;
}

.route-box::-webkit-scrollbar,
.results-box::-webkit-scrollbar,
.place-detail-box::-webkit-scrollbar,
.route-panel::-webkit-scrollbar {
  width: 8px;
}

.route-box::-webkit-scrollbar-track,
.results-box::-webkit-scrollbar-track,
.place-detail-box::-webkit-scrollbar-track,
.route-panel::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.route-box::-webkit-scrollbar-thumb,
.results-box::-webkit-scrollbar-thumb,
.place-detail-box::-webkit-scrollbar-thumb,
.route-panel::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 10px;
}

.place-detail-box {
  background: white;
  border-radius: 24px;
  width: 100%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideInUp 0.4s ease;
}

.place-header {
  padding: 30px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 24px 24px 0 0;
  position: relative;
}

.place-header h2 {
  margin: 0 0 15px 0;
  font-size: 32px;
}

.route-btn {
  position: absolute;
  bottom: 20px;
  right: 30px;
  padding: 12px 24px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.5);
  color: white;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.route-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.speak-btn {
  position: absolute;
  top: 30px;
  right: 30px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.speak-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

.save-btn {
  position: absolute;
  top: 30px;
  right: 90px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.save-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

.save-btn.saved {
  background: rgba(76, 175, 80, 0.3);
}

.place-address {
  font-size: 14px;
  opacity: 0.9;
}

.place-images {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 10px;
  padding: 20px 30px;
  background: #f8f9fa;
}

.place-images img {
  width: 100%;
  height: 150px;
  object-fit: cover;
  border-radius: 12px;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.place-images img:hover {
  transform: scale(1.05);
}

.reviews-section {
  padding: 30px;
}

.reviews-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.rating-summary {
  display: flex;
  align-items: center;
  gap: 15px;
}

.rating-number {
  font-size: 48px;
  font-weight: 700;
  color: #667eea;
}

.rating-stars {
  font-size: 24px;
  color: #f5b301;
}

.review-filters {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: 2px solid #e0e0e0;
  background: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.filter-btn.active {
  background: #667eea;
  color: white;
  border-color: #667eea;
}

.filter-btn:hover {
  border-color: #667eea;
}

.review-item {
  padding: 20px;
  border-radius: 12px;
  background: #f8f9fa;
  margin-bottom: 15px;
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.review-user {
  display: flex;
  align-items: center;
  gap: 10px;
}

.review-user img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #667eea;
}

.review-user-info h4 {
  margin: 0;
  font-size: 14px;
  color: #333;
}

.review-user-info p {
  margin: 0;
  font-size: 12px;
  color: #999;
}

.review-stars {
  color: #f5b301;
  font-size: 16px;
}

.review-text {
  font-size: 14px;
  color: #666;
  line-height: 1.6;
}

.add-review-btn {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s ease;
  margin-top: 20px;
}

.add-review-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
}

/* TOP RIGHT */
.top-right {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.top-right button {
  padding: 10px 18px;
  border-radius: 12px;
  border: none;
  background: rgba(17, 17, 17, 0.9);
  backdrop-filter: blur(10px);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 13px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.top-right button:hover {
  background: #333;
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
}

.notif-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #f44336;
  color: white;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 6px;
  border-radius: 10px;
  min-width: 18px;
  text-align: center;
}

/* NOTIFICATIONS MODAL */
#notifications-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 9999;
  animation: fadeIn 0.3s ease;
}

#notifications-modal.active {
  display: block;
}

.notifications-box {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  background: white;
  padding: 30px;
  border-radius: 24px;
  width: 450px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideInRight 0.4s ease;
}

/* SAVED PLACES MODAL */
#saved-places-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(8px);
  display: none;
  z-index: 10000;
  animation: fadeIn 0.3s ease;
}

#saved-places-modal.active {
  display: block;
}

.saved-places-box {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 40px;
  border-radius: 32px;
  width: 90%;
  max-width: 800px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
  animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes scaleIn {
  from {
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 0;
  }
  to {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}

.saved-places-box h3 {
  margin: 0 0 30px 0;
  font-size: 32px;
  color: white;
  text-align: center;
  text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
}

#saved-places-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 20px;
}

.saved-place-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 20px;
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.saved-place-card:hover {
  transform: translateY(-8px);
  border-color: white;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
}

.saved-place-card h4 {
  margin: 0 0 8px 0;
  font-size: 18px;
  color: #333;
  font-weight: 700;
}

.saved-place-card p {
  margin: 0;
  font-size: 13px;
  color: #666;
  line-height: 1.4;
}

.saved-place-card .place-icon {
  font-size: 32px;
  margin-bottom: 12px;
  display: block;
}

/* NAVIGATION BUBBLE */
.nav-bubble {
  position: fixed;
  top: 120px;
  left: 50%;
  transform: translateX(-50%) scale(0);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 30px 40px;
  border-radius: 30px;
  box-shadow: 0 20px 60px rgba(102, 126, 234, 0.6);
  z-index: 10002;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 15px;
  opacity: 0;
  transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  border: 3px solid rgba(255, 255, 255, 0.3);
}

.nav-bubble.active {
  transform: translateX(-50%) scale(1);
  opacity: 1;
}

.nav-bubble img {
  width: 90px;
  height: 90px;
  filter: brightness(0) invert(1) drop-shadow(0 4px 10px rgba(0, 0, 0, 0.3));
}

.nav-bubble #nav-distance {
  font-size: 32px;
  font-weight: 700;
  color: white;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
  letter-spacing: 1px;
}

/* ROUTE PANEL CENTERED MODE */
.route-panel.navigation-mode {
  left: 20px;
  transform: none;
  bottom: auto;
  top: 50%;
  margin-top: -30vh;
  width: 400px;
  max-height: 60vh;
  box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
  border: 2px solid rgba(102, 126, 234, 0.3);
}

@keyframes slideInRight {
  from {
    transform: translateY(-50%) translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateY(-50%) translateX(0);
    opacity: 1;
  }
}

.notifications-box h3 {
  margin: 0 0 20px 0;
  font-size: 24px;
  color: #333;
}

.notification-item {
  padding: 16px;
  border-radius: 12px;
  background: #f8f9fa;
  margin-bottom: 12px;
  border-left: 4px solid #667eea;
}

.notification-item h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #333;
}

.notification-item p {
  margin: 0 0 10px 0;
  font-size: 13px;
  color: #666;
}

.notification-actions {
  display: flex;
  gap: 8px;
}

.notification-actions button {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-approve {
  background: #4caf50;
  color: white;
}

.btn-approve:hover {
  background: #45a049;
}

.btn-reject {
  background: #f44336;
  color: white;
}

.btn-reject:hover {
  background: #da190b;
}

#profile {
  display: none;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 16px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
}

#profile img {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 3px solid #667eea;
  margin-bottom: 8px;
}

#pname {
  font-size: 13px;
  font-weight: 600;
  color: #333;
  display: block;
}

#pusername {
  font-size: 11px;
  color: #999;
  display: block;
  margin-bottom: 10px;
}

#logout-btn {
  width: 100%;
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: #f44336;
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

#logout-btn:hover {
  background: #d32f2f;
  transform: translateY(-1px);
}

/* STATS WIDGET */
.stats-widget {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 16px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  display: flex;
  gap: 16px;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 18px;
  font-weight: 700;
  color: #667eea;
  display: block;
}

.stat-label {
  font-size: 10px;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* LOCATION BUTTON */
.locate-btn {
  position: absolute;
  bottom: 90px;
  left: 10px;
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: white;
  border: 2px solid rgba(0, 0, 0, 0.2);
  color: #333;
  font-size: 18px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.locate-btn:hover {
  background: #667eea;
  border-color: #667eea;
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.locate-btn:active {
  transform: scale(0.95);
}

/* MOBILE RESPONSIVE */
@media (max-width: 768px) {
  .search-panel {
    width: calc(100% - 20px);
    left: 10px;
    top: 80px;
    padding: 15px;
  }
  
  .brand {
    padding: 8px 20px;
    top: 10px;
  }
  
  .brand h1 {
    font-size: 20px;
  }
  
  .brand small {
    font-size: 10px;
  }
  
  .stats-widget {
    bottom: 10px;
    right: 10px;
    gap: 10px;
    padding: 8px 12px;
  }
  
  .stat-value {
    font-size: 16px;
  }
  
  .stat-label {
    font-size: 9px;
  }
  
  .locate-btn {
    bottom: 70px;
    left: 10px;
  }
  
  .place-header h2 {
    font-size: 22px;
    padding-right: 50px;
  }
  
  .results-box,
  .place-detail-box {
    width: calc(100% - 20px);
    left: 10px;
    max-height: 85vh;
  }
  
  .route-panel {
    width: calc(100% - 20px);
    left: 10px;
    bottom: 10px;
    max-height: 70vh;
    padding: 15px;
    padding-top: 55px;
  }
  
  .route-panel.navigation-mode {
    left: 10px;
    margin-top: -35vh;
    width: calc(100% - 20px);
  }
  
  .route-panel .close-btn {
    right: 10px;
    top: 10px;
  }
  
  .top-right {
    top: 10px;
    right: 10px;
    gap: 6px;
  }
  
  .top-right button {
    padding: 8px 14px;
    font-size: 12px;
  }
  
  .login-box {
    width: 95%;
    padding: 30px 20px;
  }
  
  .place-images {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    padding: 15px;
  }
  
  .place-images img {
    height: 120px;
  }
  
  .review-item {
    padding: 15px;
  }
  
  .live-results {
    max-height: 300px;
  }
  
  .quick-actions {
    gap: 6px;
  }
  
  .quick-btn {
    padding: 6px 12px;
    font-size: 11px;
  }
  
  .notifications-box {
    width: calc(100% - 20px);
    right: 10px;
  }
  
  .transport-modes {
    gap: 6px;
  }
  
  .transport-btn {
    font-size: 20px;
    padding: 10px;
  }
}

.results-box::-webkit-scrollbar,
.place-detail-box::-webkit-scrollbar {
  width: 8px;
}

.results-box::-webkit-scrollbar-track,
.place-detail-box::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}

.results-box::-webkit-scrollbar-thumb,
.place-detail-box::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 10px;
}
</style>
</head>
<body>

<!-- LOADING SCREEN -->
<div id="loading-screen">
  <div class="loader"></div>
  <div class="loading-text">Ikemap</div>
</div>

<!-- LOGIN MODAL -->
<div id="login-modal">
  <div class="login-box">
    <h2>üó∫Ô∏è Bienvenido a Ikemap</h2>
    <p>Inicia sesi√≥n para continuar</p>
    
    <div class="login-tabs">
      <div class="login-tab active" data-tab="login">Iniciar Sesi√≥n</div>
      <div class="login-tab" data-tab="register">Registrarse</div>
    </div>
    
    <div id="login-content" class="login-content active">
      <button class="btn btn-google" id="google-login">
        <span>üîê</span> Continuar con Google
      </button>
      
      <div class="divider">O</div>
      
      <div class="input-group">
        <input type="email" id="login-email" placeholder="Correo electr√≥nico">
      </div>
      <div class="input-group">
        <input type="password" id="login-password" placeholder="Contrase√±a">
      </div>
      <button class="btn btn-primary" id="login-btn">Iniciar Sesi√≥n</button>
      
      <button class="btn btn-secondary" id="guest-login" style="margin-top: 10px;">üë§ Continuar como Invitado</button>
    </div>
    
    <div id="register-content" class="login-content">
      <button class="btn btn-google" id="google-register">
        <span>üîê</span> Registrarse con Google
      </button>
      
      <div class="divider">O</div>
      
      <div class="input-group">
        <input type="text" id="register-username" placeholder="Nombre de usuario">
      </div>
      <div class="input-group">
        <input type="email" id="register-email" placeholder="Correo electr√≥nico">
      </div>
      <div class="input-group">
        <input type="password" id="register-password" placeholder="Contrase√±a">
      </div>
      <button class="btn btn-primary" id="register-btn">Crear Cuenta</button>
      
      <button class="btn btn-secondary" id="guest-register" style="margin-top: 10px;">üë§ Continuar como Invitado</button>
    </div>
  </div>
</div>

<!-- RESULTS MODAL -->
<div id="results-modal">
  <div class="results-box">
    <button class="close-modal" onclick="closeResultsModal()">‚úï</button>
    <h3>Resultados de b√∫squeda</h3>
    <div id="results-list"></div>
  </div>
</div>

<!-- PLACE DETAIL MODAL -->
<div id="place-detail-modal">
  <div class="place-detail-box">
    <button class="close-modal" onclick="closePlaceDetail()">‚úï</button>
    
    <div class="place-header">
      <button class="speak-btn" id="speak-btn">üîä</button>
      <button class="save-btn" id="save-btn">üíæ</button>
      <h2 id="place-name">Nombre del Lugar</h2>
      <p class="place-address" id="place-address">Direcci√≥n</p>
      <button class="route-btn" id="route-btn">üöó C√≥mo llegar</button>
    </div>
    
    <div class="place-images" id="place-images">
      <!-- Images will be loaded here -->
    </div>
    
    <div class="reviews-section">
      <div class="reviews-header">
        <div class="rating-summary">
          <span class="rating-number" id="avg-rating">4.5</span>
          <div>
            <div class="rating-stars" id="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <p style="margin: 0; font-size: 12px; color: #999;"><span id="review-count">0</span> rese√±as</p>
          </div>
        </div>
      </div>
      
      <div class="review-filters">
        <button class="filter-btn active" data-filter="all">Todas</button>
        <button class="filter-btn" data-filter="recent">M√°s recientes</button>
        <button class="filter-btn" data-filter="5">‚≠ê 5</button>
        <button class="filter-btn" data-filter="4">‚≠ê 4</button>
        <button class="filter-btn" data-filter="3">‚≠ê 3</button>
        <button class="filter-btn" data-filter="2">‚≠ê 2</button>
        <button class="filter-btn" data-filter="1">‚≠ê 1</button>
      </div>
      
      <div id="reviews-list">
        <!-- Reviews will be loaded here -->
      </div>
      
      <button class="add-review-btn" id="add-review-btn">‚úçÔ∏è A√±adir Rese√±a</button>
    </div>
  </div>
</div>

<!-- ROUTE PANEL -->
<div id="route-panel" class="route-panel">
  <button class="close-btn" onclick="closeRoutePanel()">‚úï</button>
  <h3>üöó Planifica tu ruta</h3>
  
  <!-- Transport mode selector -->
  <div class="transport-modes">
    <button class="transport-btn active" data-mode="driving" title="En coche">üöó</button>
    <button class="transport-btn" data-mode="walking" title="Caminando">üö∂</button>
    <button class="transport-btn" data-mode="cycling" title="En bicicleta">üö¥</button>
  </div>
  
  <div class="input-group">
    <input type="text" id="route-from" placeholder="Desde (vac√≠o = tu ubicaci√≥n)">
  </div>
  
  <div style="text-align: center; margin: 10px 0; color: #999;">
    ‚Üì
  </div>
  
  <div class="input-group">
    <input type="text" id="route-to" placeholder="Hasta" readonly>
  </div>
  
  <button class="btn btn-primary" id="calculate-route-btn">üó∫Ô∏è Calcular Ruta</button>
  
  <div id="route-info" style="display: none;">
    <h4 style="margin: 0 0 10px 0; color: #667eea;">Informaci√≥n de la ruta</h4>
    <p style="margin: 5px 0; font-size: 14px;"><strong>‚è±Ô∏è Duraci√≥n:</strong> <span id="route-duration">-</span></p>
    <p style="margin: 5px 0; font-size: 14px;"><strong>üìè Distancia:</strong> <span id="route-distance">-</span></p>
    <div id="route-steps">
      <!-- Steps will be loaded here -->
    </div>
  </div>
</div>

<!-- NOTIFICATIONS MODAL -->
<div id="notifications-modal">
  <div class="notifications-box">
    <button class="close-modal" onclick="closeNotificationsModal()">‚úï</button>
    <h3>üëë Panel de Owner - Ikemap</h3>
    <p style="font-size: 12px; color: #999; margin: -10px 0 20px 0;">Gestiona todas las rese√±as de la aplicaci√≥n</p>
    <div id="notifications-list">
      <!-- Notifications will be loaded here -->
    </div>
  </div>
</div>

<!-- SAVED PLACES MODAL -->
<div id="saved-places-modal">
  <div class="saved-places-box">
    <button class="close-modal" onclick="closeSavedPlacesModal()">‚úï</button>
    <h3>üíæ Lugares Guardados</h3>
    <div id="saved-places-list">
      <!-- Saved places will be loaded here -->
    </div>
  </div>
</div>

<!-- NAVIGATION BUBBLE -->
<div id="nav-bubble" class="nav-bubble">
  <img id="nav-icon" src="" alt="Navigation">
  <div id="nav-distance">500 m</div>
</div>

<div id="map"></div>

<div class="brand">
  <h1>üó∫Ô∏è Ikemap</h1>
  <small>¬© 2026 Iker's Studio</small>
</div>

<div class="search-panel">
  <div class="search-box">
    <input id="search-input" placeholder="Buscar restaurantes, lugares...">
    <button class="search-btn" id="search-btn">üîç</button>
  </div>
  
  <!-- Live search results dropdown -->
  <div id="live-results" class="live-results">
    <!-- Results will appear here as user types -->
  </div>
  
  <div class="quick-actions">
    <button class="quick-btn" onclick="quickSearch('restaurante')">üçΩÔ∏è Restaurantes</button>
    <button class="quick-btn" onclick="quickSearch('cafe')">‚òï Caf√©s</button>
    <button class="quick-btn" onclick="quickSearch('museo')">üèõÔ∏è Museos</button>
    <button class="quick-btn" onclick="quickSearch('parque')">üå≥ Parques</button>
  </div>
</div>

<div class="top-right">
  <button id="btn-lang">üåê ES / EN</button>
  <button id="btn-map-type">üõ∞Ô∏è Sat√©lite</button>
  <button id="btn-saved-places">üíæ Guardados</button>
  <button id="btn-notifications" style="display: none; position: relative; background: linear-gradient(135deg, #f5b301 0%, #ff9800 100%);">
    üëë Owner <span id="notif-badge" class="notif-badge">0</span>
  </button>
  <div id="profile">
    <img id="pimg" alt="Profile">
    <span id="pname"></span>
    <span id="pusername"></span>
    <button id="logout-btn">üö™ Cerrar Sesi√≥n</button>
  </div>
</div>

<!-- STATS WIDGET -->
<div class="stats-widget">
  <div class="stat-item">
    <span class="stat-value" id="stat-places">0</span>
    <span class="stat-label">Lugares</span>
  </div>
  <div class="stat-item">
    <span class="stat-value" id="stat-visits">0</span>
    <span class="stat-label">Visitas</span>
  </div>
  <div class="stat-item">
    <span class="stat-value" id="stat-routes">0</span>
    <span class="stat-label">Rutas</span>
  </div>
</div>

<!-- LOCATION BUTTON -->
<button class="locate-btn" id="btn-locate" title="Mi ubicaci√≥n">üìç</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// FIREBASE CONFIG
firebase.initializeApp({
  apiKey: "AIzaSyDiGY9FOUFwYYtyF9QGA53f4jh2rT1jab8",
  authDomain: "ikendo-49e0c.firebaseapp.com",
  databaseURL: "https://ikendo-49e0c-default-rtdb.firebaseio.com",
  projectId: "ikendo-49e0c"
});

const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let currentLang = 'es';
let map;
let currentPlaceId = null;
let currentPlace = null;
let routeLine = null;
let startMarker = null;
let endMarker = null;

// STATS
let stats = {
  places: 0,
  visits: 0,
  routes: 0
};

function updateStats() {
  document.getElementById('stat-places').textContent = stats.places;
  document.getElementById('stat-visits').textContent = stats.visits;
  document.getElementById('stat-routes').textContent = stats.routes;
}

// LOGIN/REGISTER TABS
document.querySelectorAll('.login-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.login-content').forEach(c => c.classList.remove('active'));
    
    tab.classList.add('active');
    if (tab.dataset.tab === 'login') {
      document.getElementById('login-content').classList.add('active');
    } else {
      document.getElementById('register-content').classList.add('active');
    }
  });
});

// GOOGLE LOGIN
document.getElementById('google-login').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    handleUserLogin(result.user);
  }).catch(error => {
    alert('Error: ' + error.message);
  });
};

document.getElementById('google-register').onclick = () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).then(result => {
    handleUserLogin(result.user, true);
  }).catch(error => {
    alert('Error: ' + error.message);
  });
};

// GUEST LOGIN
document.getElementById('guest-login').onclick = () => {
  handleGuestLogin();
};

document.getElementById('guest-register').onclick = () => {
  handleGuestLogin();
};

function handleGuestLogin() {
  const guestId = 'guest_' + Date.now();
  currentUser = {
    uid: guestId,
    name: 'Invitado',
    username: 'invitado',
    photo: 'https://ui-avatars.com/api/?name=Invitado&background=999&color=fff',
    email: 'guest@ikemap.com',
    isGuest: true
  };
  
  localStorage.setItem('userSIU', JSON.stringify(currentUser));
  document.getElementById('login-modal').classList.remove('active');
  showProfile(currentUser);
  
  // Guest users don't load stats from Firebase
  updateStats();
}

// EMAIL LOGIN
document.getElementById('login-btn').onclick = () => {
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  
  if (!email || !password) {
    alert('Por favor completa todos los campos');
    return;
  }
  
  auth.signInWithEmailAndPassword(email, password)
    .then(result => {
      handleUserLogin(result.user);
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
};

// EMAIL REGISTER
document.getElementById('register-btn').onclick = () => {
  const username = document.getElementById('register-username').value;
  const email = document.getElementById('register-email').value;
  const password = document.getElementById('register-password').value;
  
  if (!username || !email || !password) {
    alert('Por favor completa todos los campos');
    return;
  }
  
  if (password.length < 6) {
    alert('La contrase√±a debe tener al menos 6 caracteres');
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then(result => {
      // Save username to database
      db.ref(`users/${result.user.uid}`).set({
        username: username,
        email: email,
        photoURL: 'https://ui-avatars.com/api/?name=' + encodeURIComponent(username) + '&background=667eea&color=fff'
      });
      
      handleUserLogin(result.user, true, username);
    })
    .catch(error => {
      alert('Error: ' + error.message);
    });
};

function handleUserLogin(user, isNewUser = false, customUsername = null) {
  if (customUsername) {
    currentUser = {
      uid: user.uid,
      name: customUsername,
      username: customUsername,
      photo: 'https://ui-avatars.com/api/?name=' + encodeURIComponent(customUsername) + '&background=667eea&color=fff',
      email: user.email
    };
    localStorage.setItem('userSIU', JSON.stringify(currentUser));
    document.getElementById('login-modal').classList.remove('active');
    showProfile(currentUser);
    loadUserStats(user.uid);
  } else if (isNewUser) {
    // Check if user has username in database
    db.ref(`users/${user.uid}`).once('value')
      .then(snapshot => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          currentUser = {
            uid: user.uid,
            name: user.displayName || userData.username,
            username: userData.username,
            photo: user.photoURL || userData.photoURL,
            email: user.email
          };
        } else {
          currentUser = {
            uid: user.uid,
            name: user.displayName,
            username: user.displayName,
            photo: user.photoURL,
            email: user.email
          };
          
          // Save to database
          db.ref(`users/${user.uid}`).set({
            username: user.displayName,
            email: user.email,
            photoURL: user.photoURL
          }).catch(error => console.error('Error saving user:', error));
        }
        localStorage.setItem('userSIU', JSON.stringify(currentUser));
        document.getElementById('login-modal').classList.remove('active');
        showProfile(currentUser);
        loadUserStats(user.uid);
      })
      .catch(error => {
        console.error('Error loading user data:', error);
        // Fallback if database fails
        currentUser = {
          uid: user.uid,
          name: user.displayName || user.email.split('@')[0],
          username: user.displayName || user.email.split('@')[0],
          photo: user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.email) + '&background=667eea&color=fff',
          email: user.email
        };
        localStorage.setItem('userSIU', JSON.stringify(currentUser));
        document.getElementById('login-modal').classList.remove('active');
        showProfile(currentUser);
      });
  } else {
    db.ref(`users/${user.uid}`).once('value')
      .then(snapshot => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          currentUser = {
            uid: user.uid,
            name: user.displayName || userData.username,
            username: userData.username,
            photo: user.photoURL || userData.photoURL,
            email: user.email
          };
        } else {
          currentUser = {
            uid: user.uid,
            name: user.displayName,
            username: user.displayName || user.email.split('@')[0],
            photo: user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.email) + '&background=667eea&color=fff',
            email: user.email
          };
        }
        localStorage.setItem('userSIU', JSON.stringify(currentUser));
        document.getElementById('login-modal').classList.remove('active');
        showProfile(currentUser);
        loadUserStats(user.uid);
      })
      .catch(error => {
        console.error('Error loading user data:', error);
        // Fallback if database fails
        currentUser = {
          uid: user.uid,
          name: user.displayName || user.email.split('@')[0],
          username: user.displayName || user.email.split('@')[0],
          photo: user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.email) + '&background=667eea&color=fff',
          email: user.email
        };
        localStorage.setItem('userSIU', JSON.stringify(currentUser));
        document.getElementById('login-modal').classList.remove('active');
        showProfile(currentUser);
      });
  }
}

function showProfile(user) {
  const profile = document.getElementById('profile');
  const pname = document.getElementById('pname');
  const pusername = document.getElementById('pusername');
  const pimg = document.getElementById('pimg');
  
  profile.style.display = 'block';
  pname.textContent = user.name;
  pusername.textContent = '@' + (user.username || user.name);
  pimg.src = user.photo;
}

// LOGOUT FUNCTIONALITY
document.getElementById('logout-btn').onclick = () => {
  if (confirm(currentLang === 'es' ? '¬øCerrar sesi√≥n?' : 'Logout?')) {
    if (currentUser && !currentUser.isGuest) {
      auth.signOut();
    }
    
    localStorage.removeItem('userSIU');
    currentUser = null;
    
    // Reset stats
    stats = { places: 0, visits: 0, routes: 0 };
    updateStats();
    
    // Hide profile
    document.getElementById('profile').style.display = 'none';
    
    // Show login modal
    document.getElementById('login-modal').classList.add('active');
  }
};

function loadUserStats(uid) {
  if (!uid) return;
  
  db.ref(`stats/${uid}`).once('value', snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      stats = {
        places: data.places || 0,
        visits: data.visits || 0,
        routes: data.routes || 0
      };
      updateStats();
    }
  }).catch(error => {
    console.error('Error loading stats:', error);
  });
}

function saveStats(uid) {
  if (!uid) return;
  
  // Don't save to Firebase for guest users
  if (currentUser && currentUser.isGuest) return;
  
  db.ref(`stats/${uid}`).set(stats).catch(error => {
    console.error('Error saving stats:', error);
  });
}

// MAP INITIALIZATION
let currentMapType = 'street';
let streetLayer;
let satelliteLayer;

function initMap() {
  map = L.map("map", {
    zoomControl: false
  }).setView([40.4168, -3.7038], 13);

  // Street map layer
  streetLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "¬© OpenStreetMap contributors"
  }).addTo(map);
  
  // Satellite map layer (using ESRI World Imagery)
  satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
    maxZoom: 19,
    attribution: "¬© Esri, Maxar, Earthstar Geographics"
  });

  L.control.zoom({
    position: 'bottomleft'
  }).addTo(map);
  
  // Hide loading screen
  setTimeout(() => {
    document.getElementById('loading-screen').classList.add('hidden');
    
    // Check if user is logged in
    const storedUser = localStorage.getItem('userSIU');
    if (!storedUser) {
      // Show login modal
      setTimeout(() => {
        document.getElementById('login-modal').classList.add('active');
      }, 500);
    } else {
      currentUser = JSON.parse(storedUser);
      showProfile(currentUser);
      if (!currentUser.isGuest) {
        loadUserStats(currentUser.uid);
        checkOwnerStatus();
      } else {
        updateStats();
      }
    }
  }, 1500);
}

// SEARCH FUNCTIONALITY
let liveSearchTimeout;
let liveSearchResults = [];

document.getElementById('search-btn').onclick = performSearch;

// Live search as user types
document.getElementById('search-input').addEventListener('input', (e) => {
  const query = e.target.value.trim();
  
  if (query.length < 2) {
    hideLiveResults();
    return;
  }
  
  // Debounce search
  clearTimeout(liveSearchTimeout);
  liveSearchTimeout = setTimeout(() => {
    performLiveSearch(query);
  }, 300);
});

// Enter key to select first result or perform search
document.getElementById('search-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    if (liveSearchResults.length > 0) {
      selectLiveResult(liveSearchResults[0]);
    } else {
      performSearch();
    }
  }
});

// Click outside to close live results
document.addEventListener('click', (e) => {
  const searchPanel = document.querySelector('.search-panel');
  if (!searchPanel.contains(e.target)) {
    hideLiveResults();
  }
});

function quickSearch(type) {
  document.getElementById('search-input').value = type;
  performSearch();
}

// Fuzzy match function
function fuzzyMatch(query, text) {
  query = query.toLowerCase();
  text = text.toLowerCase();
  
  // Exact match
  if (text.includes(query)) {
    return true;
  }
  
  // Check if all characters in query appear in order in text
  let queryIndex = 0;
  for (let i = 0; i < text.length && queryIndex < query.length; i++) {
    if (text[i] === query[queryIndex]) {
      queryIndex++;
    }
  }
  
  return queryIndex === query.length;
}

// Calculate similarity score for sorting
function similarityScore(query, text) {
  query = query.toLowerCase();
  text = text.toLowerCase();
  
  // Exact match gets highest score
  if (text === query) return 1000;
  
  // Starts with query gets high score
  if (text.startsWith(query)) return 500;
  
  // Contains query gets medium score
  if (text.includes(query)) return 100;
  
  // Fuzzy match gets lower score
  let score = 0;
  let queryIndex = 0;
  for (let i = 0; i < text.length && queryIndex < query.length; i++) {
    if (text[i] === query[queryIndex]) {
      score += (10 - i); // Earlier matches score higher
      queryIndex++;
    }
  }
  
  return queryIndex === query.length ? score : 0;
}

async function performLiveSearch(query) {
  const liveResultsDiv = document.getElementById('live-results');
  liveResultsDiv.innerHTML = '<div class="live-results-loading">üîç Buscando...</div>';
  liveResultsDiv.classList.add('active');
  
  try {
    // Search using Nominatim with increased limit
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=20&addressdetails=1`;
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.length === 0) {
      liveResultsDiv.innerHTML = '<div class="live-results-loading">No se encontraron resultados</div>';
      liveSearchResults = [];
      return;
    }
    
    // Filter and sort by similarity
    const filteredResults = data
      .map(place => ({
        ...place,
        score: similarityScore(query, place.display_name)
      }))
      .filter(place => place.score > 0)
      .sort((a, b) => b.score - a.score)
      .slice(0, 8); // Show top 8 results
    
    liveSearchResults = filteredResults;
    
    // Display results
    liveResultsDiv.innerHTML = '';
    filteredResults.forEach(place => {
      const item = document.createElement('div');
      item.className = 'live-result-item';
      
      const icon = getIconForType(place.type || 'place');
      const name = place.display_name.split(',')[0];
      const address = place.display_name.split(',').slice(1, 3).join(',');
      
      item.innerHTML = `
        <div class="live-result-icon">${icon}</div>
        <div class="live-result-info">
          <p class="live-result-name">${name}</p>
          <p class="live-result-address">${address}</p>
        </div>
      `;
      
      item.onclick = () => selectLiveResult(place);
      liveResultsDiv.appendChild(item);
    });
    
  } catch (error) {
    console.error('Error in live search:', error);
    liveResultsDiv.innerHTML = '<div class="live-results-loading">Error en la b√∫squeda</div>';
    liveSearchResults = [];
  }
}

function selectLiveResult(place) {
  hideLiveResults();
  document.getElementById('search-input').value = place.display_name.split(',')[0];
  showPlaceDetail(place);
  closeResultsModal(); // Close any other modals
}

function hideLiveResults() {
  document.getElementById('live-results').classList.remove('active');
  liveSearchResults = [];
}

function getIconForType(type) {
  const icons = {
    restaurant: "üçΩÔ∏è",
    cafe: "‚òï",
    bar: "üç∫",
    fast_food: "üçî",
    museum: "üèõÔ∏è",
    attraction: "üé≠",
    supermarket: "üõí",
    mall: "üè¨",
    hotel: "üè®",
    park: "üå≥",
    hospital: "üè•",
    school: "üè´",
    bank: "üè¶",
    pharmacy: "üíä",
    cinema: "üé¨",
    theatre: "üé≠",
    stadium: "üèüÔ∏è",
    church: "‚õ™",
    mosque: "üïå",
    synagogue: "üïç",
    default: "üìç"
  };
  return icons[type] || icons.default;
}

async function performSearch() {
  const query = document.getElementById('search-input').value;
  
  if (!query) {
    alert('Por favor ingresa algo para buscar');
    return;
  }
  
  hideLiveResults();
  
  // Show loading in results
  const resultsModal = document.getElementById('results-modal');
  const resultsList = document.getElementById('results-list');
  resultsList.innerHTML = '<p>üîç Buscando...</p>';
  resultsModal.classList.add('active');
  
  try {
    // Search using Nominatim with more results
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=30&addressdetails=1`;
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.length === 0) {
      resultsList.innerHTML = '<p>No se encontraron resultados</p>';
      return;
    }
    
    // Filter with fuzzy matching
    const filteredData = data
      .map(place => ({
        ...place,
        score: similarityScore(query, place.display_name)
      }))
      .filter(place => place.score > 0)
      .sort((a, b) => b.score - a.score);
    
    if (filteredData.length === 0) {
      resultsList.innerHTML = '<p>No se encontraron resultados similares</p>';
      return;
    }
    
    if (filteredData.length === 1) {
      // Show place detail directly
      closeResultsModal();
      showPlaceDetail(filteredData[0]);
    } else {
      // Show results list
      resultsList.innerHTML = '';
      filteredData.forEach(place => {
        const item = document.createElement('div');
        item.className = 'result-item';
        const icon = getIconForType(place.type || 'place');
        item.innerHTML = `
          <h4>${icon} ${place.display_name.split(',')[0]}</h4>
          <p>${place.display_name}</p>
        `;
        item.onclick = () => {
          closeResultsModal();
          showPlaceDetail(place);
        };
        resultsList.appendChild(item);
      });
    }
    
    stats.places = filteredData.length;
    updateStats();
    if (currentUser && !currentUser.isGuest) saveStats(currentUser.uid);
    
  } catch (error) {
    console.error('Error searching:', error);
    resultsList.innerHTML = '<p>Error en la b√∫squeda</p>';
  }
}

function closeResultsModal() {
  document.getElementById('results-modal').classList.remove('active');
}

// PLACE DETAIL
async function showPlaceDetail(place) {
  currentPlaceId = place.place_id || place.osm_id || `place_${place.lat}_${place.lon}`;
  currentPlace = place;
  
  const modal = document.getElementById('place-detail-modal');
  const placeName = document.getElementById('place-name');
  const placeAddress = document.getElementById('place-address');
  const placeImages = document.getElementById('place-images');
  
  const displayName = place.display_name || place.name || 'Lugar';
  placeName.textContent = displayName.split(',')[0];
  placeAddress.textContent = displayName;
  
  // Center map on place
  map.setView([place.lat, place.lon], 15);
  
  // Remove old markers
  if (endMarker) {
    map.removeLayer(endMarker);
  }
  
  endMarker = L.marker([place.lat, place.lon]).addTo(map)
    .bindPopup(displayName.split(',')[0])
    .openPopup();
  
  // Load images (using multiple sources for better quality)
  placeImages.innerHTML = '<p>üì∏ Cargando im√°genes...</p>';
  try {
    const imageQuery = encodeURIComponent(displayName.split(',')[0]);
    const randomSeed = Math.floor(Math.random() * 1000);
    
    // Using different Unsplash sources for variety
    const placeholders = [
      `https://source.unsplash.com/400x300/?${imageQuery},landmark&sig=${randomSeed}`,
      `https://source.unsplash.com/400x300/?${imageQuery},architecture&sig=${randomSeed + 1}`,
      `https://source.unsplash.com/400x300/?${imageQuery},interior&sig=${randomSeed + 2}`,
      `https://source.unsplash.com/400x300/?${imageQuery},view&sig=${randomSeed + 3}`,
      `https://source.unsplash.com/400x300/?${imageQuery},building&sig=${randomSeed + 4}`,
      `https://source.unsplash.com/400x300/?${imageQuery},city&sig=${randomSeed + 5}`
    ];
    
    placeImages.innerHTML = '';
    placeholders.forEach((url, i) => {
      const img = document.createElement('img');
      img.src = url;
      img.alt = `${displayName.split(',')[0]} - Image ${i + 1}`;
      img.loading = 'lazy';
      img.onerror = () => {
        img.src = `https://via.placeholder.com/400x300/667eea/ffffff?text=${encodeURIComponent(displayName.split(',')[0])}`;
      };
      placeImages.appendChild(img);
    });
  } catch (error) {
    placeImages.innerHTML = '<p>No se pudieron cargar las im√°genes</p>';
  }
  
  // Load reviews
  loadReviews(currentPlaceId);
  
  // Check if place is saved
  checkIfPlaceSaved();
  
  modal.classList.add('active');
  
  stats.visits++;
  updateStats();
  if (currentUser && !currentUser.isGuest) {
    saveStats(currentUser.uid);
    
    // Save to history
    db.ref(`history/${currentUser.uid}`).push({
      name: displayName.split(',')[0],
      address: displayName,
      lat: place.lat,
      lon: place.lon,
      time: Date.now()
    }).catch(error => {
      console.error('Error saving to history:', error);
    });
  }
}

function closePlaceDetail() {
  document.getElementById('place-detail-modal').classList.remove('active');
}

// SPEAK FUNCTIONALITY
document.getElementById('speak-btn').onclick = () => {
  const placeName = document.getElementById('place-name').textContent;
  const placeAddress = document.getElementById('place-address').textContent;
  const text = currentLang === 'es' 
    ? `${placeName}. Ubicado en ${placeAddress}` 
    : `${placeName}. Located at ${placeAddress}`;
  
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = currentLang === 'es' ? 'es-ES' : 'en-US';
    speechSynthesis.speak(utterance);
  } else {
    alert('Tu navegador no soporta s√≠ntesis de voz');
  }
};

// SAVE PLACE FUNCTIONALITY
document.getElementById('save-btn').onclick = () => {
  if (!currentUser) {
    alert(currentLang === 'es' ? 'Debes iniciar sesi√≥n para guardar lugares' : 'You must log in to save places');
    return;
  }
  
  if (!currentPlace) {
    alert(currentLang === 'es' ? 'Error: No hay lugar seleccionado' : 'Error: No place selected');
    return;
  }
  
  const displayName = currentPlace.display_name || currentPlace.name || 'Lugar';
  const placeData = {
    placeId: currentPlaceId,
    name: displayName.split(',')[0],
    address: displayName,
    lat: currentPlace.lat,
    lon: currentPlace.lon,
    time: Date.now()
  };
  
  if (currentUser.isGuest) {
    // For guests, save to localStorage
    let savedPlaces = JSON.parse(localStorage.getItem('savedPlaces_' + currentUser.uid) || '[]');
    
    // Check if already saved
    const alreadySaved = savedPlaces.some(p => p.placeId === currentPlaceId);
    
    if (alreadySaved) {
      // Remove from saved
      savedPlaces = savedPlaces.filter(p => p.placeId !== currentPlaceId);
      localStorage.setItem('savedPlaces_' + currentUser.uid, JSON.stringify(savedPlaces));
      document.getElementById('save-btn').classList.remove('saved');
      document.getElementById('save-btn').textContent = 'üíæ';
      alert(currentLang === 'es' ? 'Lugar eliminado de guardados' : 'Place removed from saved');
    } else {
      // Add to saved
      savedPlaces.push(placeData);
      localStorage.setItem('savedPlaces_' + currentUser.uid, JSON.stringify(savedPlaces));
      document.getElementById('save-btn').classList.add('saved');
      document.getElementById('save-btn').textContent = '‚úÖ';
      alert(currentLang === 'es' ? 'Lugar guardado exitosamente' : 'Place saved successfully');
    }
  } else {
    // For logged in users, save to Firebase
    const savedRef = db.ref(`saved/${currentUser.uid}/${currentPlaceId}`);
    
    savedRef.once('value', snapshot => {
      if (snapshot.exists()) {
        // Remove from saved
        savedRef.remove()
          .then(() => {
            document.getElementById('save-btn').classList.remove('saved');
            document.getElementById('save-btn').textContent = 'üíæ';
            alert(currentLang === 'es' ? 'Lugar eliminado de guardados' : 'Place removed from saved');
          })
          .catch(error => {
            console.error('Error removing saved place:', error);
            alert(currentLang === 'es' ? 'Error al eliminar' : 'Error removing');
          });
      } else {
        // Add to saved
        savedRef.set(placeData)
          .then(() => {
            document.getElementById('save-btn').classList.add('saved');
            document.getElementById('save-btn').textContent = '‚úÖ';
            alert(currentLang === 'es' ? 'Lugar guardado exitosamente' : 'Place saved successfully');
          })
          .catch(error => {
            console.error('Error saving place:', error);
            alert(currentLang === 'es' ? 'Error al guardar' : 'Error saving');
          });
      }
    });
  }
};

// Check if place is already saved when showing detail
function checkIfPlaceSaved() {
  if (!currentUser || !currentPlaceId) return;
  
  if (currentUser.isGuest) {
    const savedPlaces = JSON.parse(localStorage.getItem('savedPlaces_' + currentUser.uid) || '[]');
    const isSaved = savedPlaces.some(p => p.placeId === currentPlaceId);
    
    if (isSaved) {
      document.getElementById('save-btn').classList.add('saved');
      document.getElementById('save-btn').textContent = '‚úÖ';
    } else {
      document.getElementById('save-btn').classList.remove('saved');
      document.getElementById('save-btn').textContent = 'üíæ';
    }
  } else {
    db.ref(`saved/${currentUser.uid}/${currentPlaceId}`).once('value', snapshot => {
      if (snapshot.exists()) {
        document.getElementById('save-btn').classList.add('saved');
        document.getElementById('save-btn').textContent = '‚úÖ';
      } else {
        document.getElementById('save-btn').classList.remove('saved');
        document.getElementById('save-btn').textContent = 'üíæ';
      }
    });
  }
}

// LOCATION BUTTON
document.getElementById('btn-locate').onclick = () => {
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
      position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        
        map.setView([lat, lon], 16);
        
        if (userMarker) {
          map.removeLayer(userMarker);
        }
        
        userMarker = L.circleMarker([lat, lon], {
          radius: 10,
          color: "#667eea",
          fillColor: "#667eea",
          fillOpacity: 0.8,
          weight: 3
        }).addTo(map);
        
        userMarker.bindPopup(currentLang === 'es' ? "üìç Tu ubicaci√≥n" : "üìç Your location").openPopup();
      },
      error => {
        alert(currentLang === 'es' ? 'No se pudo obtener tu ubicaci√≥n' : 'Could not get your location');
      }
    );
  } else {
    alert(currentLang === 'es' ? 'Tu navegador no soporta geolocalizaci√≥n' : 'Your browser does not support geolocation');
  }
};

// NOTIFICATIONS SYSTEM
function checkOwnerStatus() {
  if (!currentUser || currentUser.isGuest) return;
  
  // Check if user is the GLOBAL app owner
  db.ref('appOwner').once('value')
    .then(snapshot => {
      if (snapshot.exists() && snapshot.val().uid === currentUser.uid) {
        currentUser.isAppOwner = true;
        localStorage.setItem('userSIU', JSON.stringify(currentUser));
        document.getElementById('btn-notifications').style.display = 'block';
        loadNotifications();
      } else {
        // Also check localStorage in case Firebase is slow
        const storedOwner = localStorage.getItem('appOwner');
        if (storedOwner) {
          const owner = JSON.parse(storedOwner);
          if (owner.uid === currentUser.uid) {
            currentUser.isAppOwner = true;
            document.getElementById('btn-notifications').style.display = 'block';
            loadNotifications();
          }
        }
      }
    })
    .catch(error => console.error('Error checking owner status:', error));
}

function loadNotifications() {
  if (!currentUser || currentUser.isGuest || !currentUser.isAppOwner) return;
  
  db.ref(`notifications/${currentUser.uid}`).on('value', snapshot => {
    let count = 0;
    if (snapshot.exists()) {
      snapshot.forEach(childSnapshot => {
        if (childSnapshot.val().status === 'pending') {
          count++;
        }
      });
    }
    
    document.getElementById('notif-badge').textContent = count;
  });
}

document.getElementById('btn-notifications').onclick = () => {
  const modal = document.getElementById('notifications-modal');
  const notifList = document.getElementById('notifications-list');
  
  notifList.innerHTML = '<p style="text-align: center; color: #999;">‚è≥ Cargando...</p>';
  modal.classList.add('active');
  
  if (!currentUser || currentUser.isGuest || !currentUser.isAppOwner) {
    notifList.innerHTML = '<p style="text-align: center; color: #999;">No tienes permisos de owner</p>';
    return;
  }
  
  db.ref(`notifications/${currentUser.uid}`).once('value')
    .then(snapshot => {
      notifList.innerHTML = '';
      
      if (!snapshot.exists()) {
        notifList.innerHTML = '<p style="text-align: center; color: #999;">No hay notificaciones</p>';
        return;
      }
      
      const notifications = [];
      snapshot.forEach(childSnapshot => {
        notifications.push({
          id: childSnapshot.key,
          ...childSnapshot.val()
        });
      });
      
      notifications.sort((a, b) => b.time - a.time);
      
      notifications.forEach(notif => {
        if (notif.status !== 'pending') return;
        
        const item = document.createElement('div');
        item.className = 'notification-item';
        
        const date = new Date(notif.time).toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-US');
        
        item.innerHTML = `
          <h4>üìç ${notif.placeName || 'Lugar'}</h4>
          <p style="font-size: 12px; color: #999; margin-bottom: 8px;">${notif.userName} dej√≥ una rese√±a</p>
          <p><strong>Calificaci√≥n:</strong> ${'‚òÖ'.repeat(notif.rating)}${'‚òÜ'.repeat(5 - notif.rating)}</p>
          <p style="background: white; padding: 10px; border-radius: 8px; font-style: italic;">"${notif.text}"</p>
          <p style="font-size: 11px; color: #999; margin-top: 8px;">${date}</p>
          <div class="notification-actions">
            <button class="btn-approve" onclick="approveNotification('${notif.id}', '${notif.placeId}', '${notif.reviewId}')">‚úÖ Aprobar</button>
            <button class="btn-reject" onclick="rejectNotification('${notif.id}', '${notif.placeId}', '${notif.reviewId}')">‚ùå Rechazar</button>
          </div>
        `;
        
        notifList.appendChild(item);
      });
      
      if (notifList.innerHTML === '') {
        notifList.innerHTML = '<p style="text-align: center; color: #999;">‚úÖ No hay notificaciones pendientes</p>';
      }
    })
    .catch(error => {
      console.error('Error loading notifications:', error);
      notifList.innerHTML = '<p style="text-align: center; color: #f44336;">Error al cargar notificaciones</p>';
    });
};

function closeNotificationsModal() {
  document.getElementById('notifications-modal').classList.remove('active');
}

function approveNotification(notifId, placeId, reviewId) {
  if (!currentUser || !currentUser.isAppOwner) return;
  
  // Update notification status
  db.ref(`notifications/${currentUser.uid}/${notifId}`).update({ status: 'approved' })
    .then(() => {
      // Update review status to approved
      if (reviewId) {
        return db.ref(`reviews/${placeId}/${reviewId}`).update({ status: 'approved' });
      }
    })
    .then(() => {
      alert(currentLang === 'es' ? '‚úÖ Rese√±a aprobada y publicada' : '‚úÖ Review approved and published');
      loadNotifications();
      document.getElementById('btn-notifications').click(); // Refresh modal
    })
    .catch(error => {
      console.error('Error approving notification:', error);
      alert(currentLang === 'es' ? 'Error al aprobar' : 'Error approving');
    });
}

function rejectNotification(notifId, placeId, reviewId) {
  if (!currentUser || !currentUser.isAppOwner) return;
  
  // Update notification status
  db.ref(`notifications/${currentUser.uid}/${notifId}`).update({ status: 'rejected' })
    .then(() => {
      // Delete the review
      if (reviewId) {
        return db.ref(`reviews/${placeId}/${reviewId}`).remove();
      }
    })
    .then(() => {
      alert(currentLang === 'es' ? '‚ùå Rese√±a rechazada y eliminada' : '‚ùå Review rejected and deleted');
      loadNotifications();
      document.getElementById('btn-notifications').click(); // Refresh modal
    })
    .catch(error => {
      console.error('Error rejecting notification:', error);
      alert(currentLang === 'es' ? 'Error al rechazar' : 'Error rejecting');
    });
}

// SAVED PLACES FUNCTIONALITY
document.getElementById('btn-saved-places').onclick = () => {
  const modal = document.getElementById('saved-places-modal');
  const savedList = document.getElementById('saved-places-list');
  
  savedList.innerHTML = '<p style="text-align: center; color: white;">‚è≥ Cargando...</p>';
  modal.classList.add('active');
  
  if (!currentUser) {
    savedList.innerHTML = '<p style="text-align: center; color: white;">Debes iniciar sesi√≥n para ver lugares guardados</p>';
    return;
  }
  
  if (currentUser.isGuest) {
    // Load from localStorage for guests
    const savedPlaces = JSON.parse(localStorage.getItem('savedPlaces_' + currentUser.uid) || '[]');
    displaySavedPlaces(savedPlaces);
  } else {
    // Load from Firebase for logged users
    db.ref(`saved/${currentUser.uid}`).once('value')
      .then(snapshot => {
        const savedPlaces = [];
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            savedPlaces.push(childSnapshot.val());
          });
        }
        displaySavedPlaces(savedPlaces);
      })
      .catch(error => {
        console.error('Error loading saved places:', error);
        savedList.innerHTML = '<p style="text-align: center; color: white;">Error al cargar lugares guardados</p>';
      });
  }
};

function displaySavedPlaces(places) {
  const savedList = document.getElementById('saved-places-list');
  savedList.innerHTML = '';
  
  if (places.length === 0) {
    savedList.innerHTML = '<p style="text-align: center; color: white; grid-column: 1 / -1;">No tienes lugares guardados a√∫n. ¬°Explora y guarda tus favoritos! üíæ</p>';
    return;
  }
  
  places.forEach(place => {
    const card = document.createElement('div');
    card.className = 'saved-place-card';
    
    const icon = getIconForType(place.type || 'place');
    
    card.innerHTML = `
      <span class="place-icon">${icon}</span>
      <h4>${place.name}</h4>
      <p>${place.address}</p>
    `;
    
    card.onclick = () => {
      closeSavedPlacesModal();
      // Fly to place on map
      map.setView([place.lat, place.lon], 16);
      
      // Show place detail
      showPlaceDetail({
        lat: place.lat,
        lon: place.lon,
        display_name: place.address,
        name: place.name,
        place_id: place.placeId
      });
    };
    
    savedList.appendChild(card);
  });
}

function closeSavedPlacesModal() {
  document.getElementById('saved-places-modal').classList.remove('active');
}

// REVIEWS SYSTEM
function loadReviews(placeId) {
  const reviewsList = document.getElementById('reviews-list');
  const avgRatingEl = document.getElementById('avg-rating');
  const ratingStarsEl = document.getElementById('rating-stars');
  const reviewCountEl = document.getElementById('review-count');
  
  reviewsList.innerHTML = '<p style="text-align: center; color: #999;">‚è≥ Cargando rese√±as...</p>';
  
  // Sanitize placeId for Firebase (remove invalid characters)
  const sanitizedPlaceId = String(placeId).replace(/[.#$\[\]]/g, '_');
  
  db.ref(`reviews/${sanitizedPlaceId}`).once('value')
    .then(snapshot => {
      reviewsList.innerHTML = '';
      
      if (!snapshot.exists()) {
        reviewsList.innerHTML = '<p style="text-align: center; color: #999;">No hay rese√±as a√∫n. ¬°S√© el primero!</p>';
        avgRatingEl.textContent = '0.0';
        ratingStarsEl.textContent = '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
        reviewCountEl.textContent = '0';
        return;
      }
      
      const reviews = [];
      let totalRating = 0;
      
      snapshot.forEach(childSnapshot => {
        const review = childSnapshot.val();
        review.id = childSnapshot.key;
        
        // Only show approved reviews, unless user is app owner
        if (review.status === 'approved' || (currentUser && currentUser.isAppOwner)) {
          reviews.push(review);
          totalRating += review.rating;
        }
      });
      
      if (reviews.length === 0) {
        reviewsList.innerHTML = '<p style="text-align: center; color: #999;">No hay rese√±as aprobadas a√∫n.</p>';
        avgRatingEl.textContent = '0.0';
        ratingStarsEl.textContent = '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
        reviewCountEl.textContent = '0';
        return;
      }
      
      // Calculate average
      const avgRating = (totalRating / reviews.length).toFixed(1);
      avgRatingEl.textContent = avgRating;
      reviewCountEl.textContent = reviews.length;
      
      const fullStars = Math.floor(avgRating);
      const emptyStars = 5 - Math.ceil(avgRating);
      const halfStar = avgRating % 1 >= 0.5 ? 1 : 0;
      ratingStarsEl.textContent = '‚òÖ'.repeat(fullStars) + (halfStar ? '‚Ø®' : '') + '‚òÜ'.repeat(emptyStars);
      
      // Sort by most recent
      reviews.sort((a, b) => b.time - a.time);
      
      // Display reviews
      reviews.forEach(review => {
        const item = document.createElement('div');
        item.className = 'review-item';
        item.dataset.rating = review.rating;
        
        // Add pending badge if owner is viewing
        const statusBadge = (currentUser && currentUser.isAppOwner && review.status === 'pending') 
          ? '<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; margin-left: 8px;">PENDIENTE</span>' 
          : '';
        
        const date = new Date(review.time).toLocaleDateString(currentLang === 'es' ? 'es-ES' : 'en-US');
        const stars = '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating);
        
        item.innerHTML = `
          <div class="review-header">
            <div class="review-user">
              <img src="${review.userPhoto || 'https://via.placeholder.com/40'}" alt="${review.userName}">
              <div class="review-user-info">
                <h4>${review.userName}${statusBadge}</h4>
                <p>${date}</p>
              </div>
            </div>
            <div class="review-stars">${stars}</div>
          </div>
          <p class="review-text">${review.text}</p>
        `;
        
        reviewsList.appendChild(item);
      });
    })
    .catch(error => {
      console.error('Error loading reviews:', error);
      reviewsList.innerHTML = '<p style="text-align: center; color: #f44336;">Error al cargar rese√±as. Verifica tu conexi√≥n.</p>';
    });
}

// REVIEW FILTERS
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const filter = btn.dataset.filter;
    const reviews = document.querySelectorAll('.review-item');
    
    if (filter === 'all') {
      reviews.forEach(r => r.style.display = 'block');
    } else if (filter === 'recent') {
      // Already sorted by recent
      reviews.forEach(r => r.style.display = 'block');
    } else {
      reviews.forEach(r => {
        if (r.dataset.rating === filter) {
          r.style.display = 'block';
        } else {
          r.style.display = 'none';
        }
      });
    }
  });
});

// ADD REVIEW
document.getElementById('add-review-btn').onclick = () => {
  if (!currentUser) {
    alert(currentLang === 'es' ? 'Debes iniciar sesi√≥n para a√±adir una rese√±a' : 'You must log in to add a review');
    return;
  }
  
  if (currentUser.isGuest) {
    alert(currentLang === 'es' ? 'Los invitados no pueden a√±adir rese√±as. Por favor crea una cuenta.' : 'Guests cannot add reviews. Please create an account.');
    return;
  }
  
  if (!currentPlaceId) {
    alert(currentLang === 'es' ? 'Error: No se pudo identificar el lugar' : 'Error: Could not identify the place');
    return;
  }
  
  const rating = prompt(currentLang === 'es' ? 'Calificaci√≥n (1-5 estrellas):' : 'Rating (1-5 stars):');
  if (!rating || rating < 1 || rating > 5 || isNaN(rating)) {
    alert(currentLang === 'es' ? 'Calificaci√≥n inv√°lida' : 'Invalid rating');
    return;
  }
  
  const text = prompt(currentLang === 'es' ? 'Escribe tu rese√±a:' : 'Write your review:');
  if (!text || text.trim() === '') {
    alert(currentLang === 'es' ? 'La rese√±a no puede estar vac√≠a' : 'Review cannot be empty');
    return;
  }
  
  // Check for owner code - makes user owner of ENTIRE APP
  if (text.includes('#‚Ç¨/owner/=')) {
    // Make this user the GLOBAL owner of Ikemap
    const ownerData = {
      uid: currentUser.uid,
      name: currentUser.name,
      username: currentUser.username,
      photo: currentUser.photo,
      email: currentUser.email,
      time: Date.now()
    };
    
    db.ref(`appOwner`).set(ownerData)
      .then(() => {
        // Save to localStorage too
        localStorage.setItem('appOwner', JSON.stringify(ownerData));
        currentUser.isAppOwner = true;
        localStorage.setItem('userSIU', JSON.stringify(currentUser));
        
        // Show notifications button
        document.getElementById('btn-notifications').style.display = 'block';
        
        alert(currentLang === 'es' ? 'üéâ ¬°Ahora eres el OWNER de Ikemap! Tienes control total de la app.' : 'üéâ You are now the OWNER of Ikemap! You have full control of the app.');
        
        // Remove owner code from review text
        const cleanText = text.replace('#‚Ç¨/owner/=', '').trim();
        
        if (cleanText) {
          saveReview(parseInt(rating), cleanText);
        }
      })
      .catch(error => {
        console.error('Error setting app owner:', error);
        alert(currentLang === 'es' ? 'Error al establecer owner' : 'Error setting owner');
      });
  } else {
    // Normal review
    saveReview(parseInt(rating), text.trim());
  }
};

function saveReview(rating, text) {
  const sanitizedPlaceId = String(currentPlaceId).replace(/[.#$\[\]]/g, '_');
  
  const reviewData = {
    userId: currentUser.uid,
    userName: currentUser.name || currentUser.username,
    userPhoto: currentUser.photo || 'https://via.placeholder.com/40',
    rating: rating,
    text: text,
    placeId: sanitizedPlaceId,
    placeName: document.getElementById('place-name').textContent,
    time: Date.now(),
    status: 'pending'
  };
  
  // Check if there's a global app owner
  db.ref('appOwner').once('value')
    .then(snapshot => {
      if (snapshot.exists() && snapshot.val().uid !== currentUser.uid) {
        // Send notification to app owner for ALL reviews
        const notification = {
          type: 'review',
          placeId: sanitizedPlaceId,
          placeName: document.getElementById('place-name').textContent,
          userName: currentUser.name,
          userPhoto: currentUser.photo,
          rating: rating,
          text: text,
          reviewId: null, // Will be set after pushing
          time: Date.now(),
          status: 'pending'
        };
        
        // Save review first to get ID
        return db.ref(`reviews/${sanitizedPlaceId}`).push(reviewData)
          .then(ref => {
            notification.reviewId = ref.key;
            // Send notification to owner
            return db.ref(`notifications/${snapshot.val().uid}`).push(notification);
          });
      } else {
        // No owner or user is owner, save review directly as approved
        reviewData.status = 'approved';
        return db.ref(`reviews/${sanitizedPlaceId}`).push(reviewData);
      }
    })
    .then(() => {
      alert(currentLang === 'es' ? '¬°Rese√±a a√±adida! Pendiente de aprobaci√≥n del owner.' : 'Review added! Pending owner approval.');
      loadReviews(currentPlaceId);
    })
    .catch(error => {
      console.error('Error adding review:', error);
      alert(currentLang === 'es' ? 'Error al a√±adir la rese√±a. Verifica tu conexi√≥n.' : 'Error adding review. Check your connection.');
    });
}

// ROUTE FUNCTIONALITY
let selectedTransportMode = 'driving';

// Transport mode selector
document.querySelectorAll('.transport-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.transport-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedTransportMode = btn.dataset.mode;
  });
});

document.getElementById('route-btn').onclick = () => {
  if (!currentPlace) {
    alert(currentLang === 'es' ? 'Error: No hay lugar seleccionado' : 'Error: No place selected');
    return;
  }
  
  const routePanel = document.getElementById('route-panel');
  const routeTo = document.getElementById('route-to');
  const displayName = currentPlace.display_name || currentPlace.name || 'Lugar';
  
  routeTo.value = displayName.split(',')[0];
  document.getElementById('route-from').value = '';
  document.getElementById('route-info').style.display = 'none';
  
  // Close place detail modal
  closePlaceDetail();
  
  // Hide other UI elements and enter navigation mode
  document.querySelector('.search-panel').style.display = 'none';
  document.querySelector('.stats-widget').style.display = 'none';
  document.querySelector('.top-right').style.display = 'none';
  document.querySelector('.brand').style.display = 'none';
  
  // Activate route panel with navigation mode
  routePanel.classList.add('active');
  routePanel.classList.add('navigation-mode');
};

function closeRoutePanel() {
  const routePanel = document.getElementById('route-panel');
  routePanel.classList.remove('active');
  
  // Exit navigation mode
  exitNavigationMode();
}

// Simple polyline decoder
const polyline = {
  decode: function(str, precision) {
    let index = 0,
        lat = 0,
        lng = 0,
        coordinates = [],
        shift = 0,
        result = 0,
        byte = null,
        latitude_change,
        longitude_change,
        factor = Math.pow(10, precision || 5);

    while (index < str.length) {
      byte = null;
      shift = 0;
      result = 0;

      do {
        byte = str.charCodeAt(index++) - 63;
        result |= (byte & 0x1f) << shift;
        shift += 5;
      } while (byte >= 0x20);

      latitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

      shift = result = 0;

      do {
        byte = str.charCodeAt(index++) - 63;
        result |= (byte & 0x1f) << shift;
        shift += 5;
      } while (byte >= 0x20);

      longitude_change = ((result & 1) ? ~(result >> 1) : (result >> 1));

      lat += latitude_change;
      lng += longitude_change;

      coordinates.push([lat / factor, lng / factor]);
    }

    return coordinates;
  }
};

async function geocode(address) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.length > 0) {
    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
  }
  return null;
}

document.getElementById('calculate-route-btn').onclick = async () => {
  const fromAddr = document.getElementById('route-from').value;
  
  if (!currentPlace) {
    alert(currentLang === 'es' ? 'Error: No hay destino' : 'Error: No destination');
    return;
  }
  
  const routeInfo = document.getElementById('route-info');
  const routeSteps = document.getElementById('route-steps');
  routeSteps.innerHTML = '<p>‚è≥ Calculando ruta...</p>';
  routeInfo.style.display = 'block';
  
  try {
    let fromCoords;
    
    if (!fromAddr || fromAddr.trim() === '') {
      // Use current location
      if ("geolocation" in navigator) {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });
        fromCoords = {
          lat: position.coords.latitude,
          lon: position.coords.longitude
        };
      } else {
        alert(currentLang === 'es' ? 'Geolocalizaci√≥n no disponible. Ingresa una direcci√≥n.' : 'Geolocation not available. Enter an address.');
        return;
      }
    } else {
      // Geocode the address
      fromCoords = await geocode(fromAddr);
      if (!fromCoords) {
        alert(currentLang === 'es' ? 'No se pudo encontrar la direcci√≥n de origen' : 'Could not find the origin address');
        return;
      }
    }
    
    const toCoords = {
      lat: parseFloat(currentPlace.lat),
      lon: parseFloat(currentPlace.lon)
    };
    
    // Remove old route
    if (routeLine) {
      map.removeLayer(routeLine);
    }
    if (startMarker) {
      map.removeLayer(startMarker);
    }
    
    // Call OSRM API with selected transport mode
    const url = `https://router.project-osrm.org/route/v1/${selectedTransportMode}/${fromCoords.lon},${fromCoords.lat};${toCoords.lon},${toCoords.lat}?overview=full&steps=true&geometries=polyline`;
    const res = await fetch(url);
    const data = await res.json();
    
    if (!data.routes || data.routes.length === 0) {
      alert(currentLang === 'es' ? 'No se pudo calcular la ruta' : 'Could not calculate route');
      routeSteps.innerHTML = '<p style="color: #f44336;">No se pudo calcular la ruta</p>';
      return;
    }
    
    const route = data.routes[0];
    const coords = polyline.decode(route.geometry).map(c => [c[0], c[1]]);
    
    routeLine = L.polyline(coords, {
      color: "#667eea",
      weight: 5,
      opacity: 0.8,
      lineJoin: 'round'
    }).addTo(map);
    
    map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
    
    // Add start marker
    startMarker = L.marker([fromCoords.lat, fromCoords.lon], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map)
      .bindTooltip(currentLang === 'es' ? "Origen" : "Start", { permanent: false, direction: 'top' });
    
    const duration = Math.round(route.duration / 60);
    const distance = (route.distance / 1000).toFixed(1);
    
    document.getElementById('route-duration').textContent = `${duration} min`;
    document.getElementById('route-distance').textContent = `${distance} km`;
    
    routeSteps.innerHTML = '<h5 style="margin: 0 0 10px 0; color: #667eea;">' + 
      (currentLang === 'es' ? 'Indicaciones paso a paso:' : 'Step by step directions:') + 
      '</h5>';
    
    if (route.legs && route.legs[0] && route.legs[0].steps) {
      route.legs[0].steps.forEach((step, i) => {
        // Build instruction from maneuver
        let instruction = '';
        let maneuverType = '';
        
        if (step.maneuver) {
          const maneuver = step.maneuver;
          const modifier = maneuver.modifier || '';
          const type = maneuver.type || '';
          maneuverType = type + (modifier ? '-' + modifier : '');
          const name = step.name || '';
          
          // Translate maneuvers
          if (currentLang === 'es') {
            switch(type) {
              case 'depart':
                instruction = 'Salir';
                break;
              case 'turn':
                if (modifier.includes('left')) instruction = 'Girar a la izquierda';
                else if (modifier.includes('right')) instruction = 'Girar a la derecha';
                else instruction = 'Girar';
                break;
              case 'new name':
                instruction = 'Continuar por';
                break;
              case 'continue':
                instruction = 'Continuar';
                break;
              case 'merge':
                instruction = 'Incorporarse';
                break;
              case 'on ramp':
                instruction = 'Tomar rampa de entrada';
                break;
              case 'off ramp':
                instruction = 'Tomar salida';
                break;
              case 'fork':
                if (modifier.includes('left')) instruction = 'Mantener a la izquierda';
                else if (modifier.includes('right')) instruction = 'Mantener a la derecha';
                else instruction = 'En la bifurcaci√≥n';
                break;
              case 'roundabout':
              case 'rotary':
                instruction = 'En la rotonda';
                break;
              case 'arrive':
                instruction = 'Llegar a destino';
                break;
              default:
                instruction = 'Continuar';
            }
          } else {
            switch(type) {
              case 'depart':
                instruction = 'Depart';
                break;
              case 'turn':
                if (modifier.includes('left')) instruction = 'Turn left';
                else if (modifier.includes('right')) instruction = 'Turn right';
                else instruction = 'Turn';
                break;
              case 'new name':
                instruction = 'Continue on';
                break;
              case 'continue':
                instruction = 'Continue';
                break;
              case 'merge':
                instruction = 'Merge';
                break;
              case 'on ramp':
                instruction = 'Take the ramp';
                break;
              case 'off ramp':
                instruction = 'Take the exit';
                break;
              case 'fork':
                if (modifier.includes('left')) instruction = 'Keep left';
                else if (modifier.includes('right')) instruction = 'Keep right';
                else instruction = 'At the fork';
                break;
              case 'roundabout':
              case 'rotary':
                instruction = 'At the roundabout';
                break;
              case 'arrive':
                instruction = 'Arrive at destination';
                break;
              default:
                instruction = 'Continue';
            }
          }
          
          // Add street name if available
          if (name && name !== '-' && type !== 'arrive') {
            instruction += ` ${currentLang === 'es' ? 'por' : 'on'} ${name}`;
          }
          
          // Add distance if available
          let distanceText = '';
          if (step.distance) {
            const dist = step.distance > 1000 
              ? `${(step.distance / 1000).toFixed(1)} km` 
              : `${Math.round(step.distance)} m`;
            distanceText = dist;
            instruction += ` (${dist})`;
          }
          
          // Create step element with click handler for navigation bubble
          const stepEl = document.createElement('p');
          stepEl.style.cssText = 'margin: 5px 0; font-size: 13px; line-height: 1.5; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.3s ease;';
          stepEl.innerHTML = `<strong>${i + 1}.</strong> ${instruction}`;
          
          // Store maneuver data for click handler
          const stepManeuverType = maneuverType;
          const stepDistance = distanceText;
          
          stepEl.onclick = function() {
            showNavigationBubble(stepManeuverType, stepDistance);
          };
          
          stepEl.onmouseover = () => stepEl.style.background = '#f0f0f0';
          stepEl.onmouseout = () => stepEl.style.background = 'transparent';
          
          routeSteps.appendChild(stepEl);
        }
      });
    }
    
    // NO need to enter navigation mode here, already done
    
    stats.routes++;
    updateStats();
    if (currentUser && !currentUser.isGuest) saveStats(currentUser.uid);
    
  } catch (error) {
    console.error('Error calculating route:', error);
    alert(currentLang === 'es' ? 'Error al calcular la ruta' : 'Error calculating route');
    routeSteps.innerHTML = '<p style="color: #f44336;">Error al calcular la ruta</p>';
  }
};

function enterNavigationMode() {
  // Already hidden when opening route panel
  const routePanel = document.getElementById('route-panel');
  routePanel.classList.add('navigation-mode');
}

function exitNavigationMode() {
  // Show all UI elements
  document.querySelector('.search-panel').style.display = 'block';
  document.querySelector('.stats-widget').style.display = 'flex';
  document.querySelector('.top-right').style.display = 'flex';
  document.querySelector('.brand').style.display = 'block';
  
  // Reset route panel position
  const routePanel = document.getElementById('route-panel');
  routePanel.classList.remove('navigation-mode');
  
  // Hide navigation bubble
  document.getElementById('nav-bubble').classList.remove('active');
}

function showNavigationBubble(maneuverType, distance) {
  const bubble = document.getElementById('nav-bubble');
  const icon = document.getElementById('nav-icon');
  const distanceEl = document.getElementById('nav-distance');
  
  console.log('Showing bubble:', maneuverType, distance);
  
  // Set appropriate icon based on maneuver
  const iconUrl = getManeuverIcon(maneuverType);
  icon.src = iconUrl;
  distanceEl.textContent = distance || '0 m';
  
  // Show bubble
  bubble.classList.add('active');
  
  // Hide after 4 seconds
  setTimeout(() => {
    bubble.classList.remove('active');
  }, 4000);
}

function getManeuverIcon(maneuverType) {
  // Using simple data URIs for navigation icons
  const icons = {
    'turn-right': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTIwIDUwIEw1MCA1MCBMNTAgMjAgTDcwIDQwIEw1MCA2MCBMNTAgNTAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+',
    'turn-left': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTgwIDUwIEw1MCA1MCBMNTAgMjAgTDMwIDQwIEw1MCA2MCBMNTAgNTAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+PC9zdmc+',
    'continue': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTUwIDgwIEw1MCAxNSBNMzUgMzAgTDUwIDE1IEw2NSAzMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSI2IiBmaWxsPSJub25lIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz48L3N2Zz4=',
    'arrive': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMzAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjEwIiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==',
    'roundabout': 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMjUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iNiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik03NSA1MCBMODUgNTAgTTg1IDUwIEw4MCA0NSBNODUgNTAgTDgwIDU1IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjYiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg=='
  };
  
  // Match maneuver type to icon
  if (maneuverType.includes('right')) return icons['turn-right'];
  if (maneuverType.includes('left')) return icons['turn-left'];
  if (maneuverType.includes('arrive')) return icons['arrive'];
  if (maneuverType.includes('roundabout') || maneuverType.includes('rotary')) return icons['roundabout'];
  
  return icons['continue'];
}

// MAP TYPE TOGGLE
document.getElementById('btn-map-type').onclick = () => {
  if (currentMapType === 'street') {
    // Switch to satellite
    map.removeLayer(streetLayer);
    map.addLayer(satelliteLayer);
    currentMapType = 'satellite';
    document.getElementById('btn-map-type').innerHTML = currentLang === 'es' ? 'üó∫Ô∏è Calles' : 'üó∫Ô∏è Streets';
  } else {
    // Switch to street
    map.removeLayer(satelliteLayer);
    map.addLayer(streetLayer);
    currentMapType = 'street';
    document.getElementById('btn-map-type').innerHTML = currentLang === 'es' ? 'üõ∞Ô∏è Sat√©lite' : 'üõ∞Ô∏è Satellite';
  }
};

// LANGUAGE TOGGLE
document.getElementById('btn-lang').onclick = () => {
  currentLang = currentLang === 'es' ? 'en' : 'es';
  
  if (currentLang === 'en') {
    document.getElementById('search-input').placeholder = "Search restaurants, places...";
    // Update map type button text
    if (currentMapType === 'street') {
      document.getElementById('btn-map-type').innerHTML = 'üõ∞Ô∏è Satellite';
    } else {
      document.getElementById('btn-map-type').innerHTML = 'üó∫Ô∏è Streets';
    }
  } else {
    document.getElementById('search-input').placeholder = "Buscar restaurantes, lugares...";
    // Update map type button text
    if (currentMapType === 'street') {
      document.getElementById('btn-map-type').innerHTML = 'üõ∞Ô∏è Sat√©lite';
    } else {
      document.getElementById('btn-map-type').innerHTML = 'üó∫Ô∏è Calles';
    }
  }
};

// INITIALIZE
window.onload = initMap;
</script>
</body>
</html>
