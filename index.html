<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa con POIs y Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html,body { margin:0; height:100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
#map { height:100%; }

/* Panel lateral izquierdo */
.panel {
  position:absolute; top:10px; left:10px;
  background:white; padding:12px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
  z-index:1000; width:300px;
}
.panel input, .panel button {
  width:100%; margin-bottom:8px; padding:8px 10px;
  border-radius:6px; border:1px solid #ccc; font-size:14px;
  outline:none; transition:0.2s;
}
.panel input:focus { border-color:#007bff; }
.panel button {
  background:#007bff; color:white; border:none; cursor:pointer; font-weight:bold;
}
.panel button:hover { background:#0056b3; }

/* InformaciÃ³n de instrucciones */
.info {
  font-size:13px; margin-top:6px;
  max-height:200px; overflow-y:auto; padding:6px;
  background:#f9f9f9; border-radius:6px; border:1px solid #ddd;
}

/* Street-view simulado */
#streetView {
  position:absolute; top:0; right:0; width:50%; height:50%;
  display:none; z-index:900; border:2px solid #333;
  background-size:cover; background-position:center; border-radius:8px;
}

/* Panel superior derecho: ajustes y login */
.top-right {
  position:absolute; top:10px; right:10px;
  z-index:1000;
  display:flex; flex-direction:column; gap:6px;
}
.top-right button {
  width:160px; font-size:13px; padding:6px 8px;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="streetView"></div>

<!-- Panel lateral izquierdo -->
<div class="panel">
  <input id="search" placeholder="Buscar lugar">
  <button id="btn-search" onclick="searchPlace()">ğŸ” Buscar</button>
  <input id="from" placeholder="Desde">
  <input id="to" placeholder="Hasta">
  <button id="btn-route" onclick="route()">ğŸš— Obtener direcciones</button>
  <button id="btn-speak" onclick="readDirections()">ğŸ”Š Escuchar indicaciones</button>
  <button id="btn-locate" onclick="locate()">ğŸ“ Mi ubicaciÃ³n</button>
  <button id="btn-dark" onclick="toggleDark()">ğŸŒ™ Modo oscuro</button>
  <button id="btn-sat" onclick="toggleSatellite()">ğŸ›° SatÃ©lite</button>
  <button id="btn-street" onclick="toggleStreetView()">ğŸ™ Vista calle</button>
  <button id="btn-poi" onclick="loadPOIs()">ğŸ“Œ Mostrar lugares</button>
  <div class="info" id="info">Las indicaciones aparecerÃ¡n aquÃ­.</div>
</div>

<!-- Panel superior derecho -->
<div class="top-right">
  <button id="btn-language" onclick="toggleLanguage()">ğŸŒ EspaÃ±ol / English</button>
  <button id="btn-login" onclick="loginGoogle()">ğŸ”‘ Iniciar sesiÃ³n con Google</button>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDiGY9FOUFwYYtyF9QGA53f4jh2rT1jab8",
  authDomain: "ikendo-49e0c.firebaseapp.com",
  databaseURL: "https://ikendo-49e0c-default-rtdb.firebaseio.com",
  projectId: "ikendo-49e0c",
  storageBucket: "ikendo-49e0c.firebasestorage.app",
  messagingSenderId: "863938515308",
  appId: "1:863938515308:web:ff662fe4e7ddb394052349"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

function loginGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then(result => alert(`${idioma==='es'?'Bienvenido':'Welcome'} ${result.user.displayName}`))
    .catch(error => alert(`Error: ${error.message}`));
}

// TraducciÃ³n de interfaz
let idioma = 'es';
function toggleLanguage(){
  idioma = idioma==='es'?'en':'es';
  updateTexts();
}

function updateTexts(){
  const t = {
    es: {
      search: "Buscar lugar",
      from: "Desde",
      to: "Hasta",
      route: "ğŸš— Obtener direcciones",
      speak: "ğŸ”Š Escuchar indicaciones",
      locate: "ğŸ“ Mi ubicaciÃ³n",
      dark: "ğŸŒ™ Modo oscuro",
      sat: "ğŸ›° SatÃ©lite",
      street: "ğŸ™ Vista calle",
      poi: "ğŸ“Œ Mostrar lugares",
      infoDefault: "Las indicaciones aparecerÃ¡n aquÃ­.",
      login: "ğŸ”‘ Iniciar sesiÃ³n con Google",
      language: "ğŸŒ EspaÃ±ol / English"
    },
    en: {
      search: "Search place",
      from: "From",
      to: "To",
      route: "ğŸš— Get directions",
      speak: "ğŸ”Š Listen instructions",
      locate: "ğŸ“ My location",
      dark: "ğŸŒ™ Dark mode",
      sat: "ğŸ›° Satellite",
      street: "ğŸ™ Street view",
      poi: "ğŸ“Œ Show places",
      infoDefault: "Directions will appear here.",
      login: "ğŸ”‘ Sign in with Google",
      language: "ğŸŒ Spanish / English"
    }
  };
  document.getElementById("search").placeholder = t[idioma].search;
  document.getElementById("from").placeholder = t[idioma].from;
  document.getElementById("to").placeholder = t[idioma].to;
  document.getElementById("btn-route").innerText = t[idioma].route;
  document.getElementById("btn-speak").innerText = t[idioma].speak;
  document.getElementById("btn-locate").innerText = t[idioma].locate;
  document.getElementById("btn-dark").innerText = t[idioma].dark;
  document.getElementById("btn-sat").innerText = t[idioma].sat;
  document.getElementById("btn-street").innerText = t[idioma].street;
  document.getElementById("btn-poi").innerText = t[idioma].poi;
  document.getElementById("info").innerText = t[idioma].infoDefault;
  document.getElementById("btn-login").innerText = t[idioma].login;
  document.getElementById("btn-language").innerText = t[idioma].language;
}

// Inicializamos textos
updateTexts();

// Mapa Leaflet
let map = L.map("map").setView([40.4168,-3.7038],13);
const normalLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:"Â© OSM"});
const darkLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19});
const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19});
normalLayer.addTo(map);
let currentLayer="normal";

let marker, routeLine;
let streetVisible=false;
let poiLayer = L.layerGroup().addTo(map);
let lastSteps = [];

// Funciones principales
async function searchPlace(){
  const q=document.getElementById("search").value;
  if(!q) return;
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
  const data=await res.json();
  if(!data[0]) return;
  const lat=data[0].lat, lon=data[0].lon;
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],15);
}

async function geocode(text){
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${text}`);
  const data=await res.json();
  return data[0];
}

async function route(){
  const from=document.getElementById("from").value;
  const to=document.getElementById("to").value;
  if(!from||!to) return;
  const f=await geocode(from), t=await geocode(to);
  if(!f||!t) return;
  const url=`https://router.project-osrm.org/route/v1/driving/${f.lon},${f.lat};${t.lon},${t.lat}?overview=full&geometries=geojson&steps=true`;
  const res=await fetch(url);
  const data=await res.json();
  const routeData=data.routes[0];
  const coords=routeData.geometry.coordinates.map(c=>[c[1],c[0]]);
  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{weight:5,color:"#007bff"}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  // Pasos legibles segÃºn idioma
  const steps = routeData.legs[0].steps.map((s,i)=>{
    const tipo = s.maneuver.type || '';
    const mod = s.maneuver.modifier ? ` (${s.maneuver.modifier})` : '';
    const calle = s.name || '';
    return idioma==='es'? `${i+1}. ${tipo}${mod} en ${calle}` : `${i+1}. ${tipo}${mod} on ${calle}`;
  });
  lastSteps = steps;
  document.getElementById("info").innerHTML = `<b>${idioma==='es'?'Indicaciones':'Directions'}:</b><br>` + steps.join("<br>");
}

function readDirections(){
  if(lastSteps.length === 0) return;
  if('speechSynthesis' in window){
    speechSynthesis.cancel();
    lastSteps.forEach(step => speechSynthesis.speak(new SpeechSynthesisUtterance(step)));
  }
}

function locate(){
  map.locate({setView:true,maxZoom:16});
  map.on("locationfound",e=>{
    L.marker(e.latlng).addTo(map).bindPopup(idioma==='es'?"TÃº estÃ¡s aquÃ­":"You are here").openPopup();
  });
}

function toggleDark(){
  map.eachLayer(l=>map.removeLayer(l));
  currentLayer=currentLayer==="dark"?"normal":"dark";
  (currentLayer==="dark"?darkLayer:normalLayer).addTo(map);
}
function toggleSatellite(){
  map.eachLayer(l=>map.removeLayer(l));
  satelliteLayer.addTo(map);
  currentLayer="satellite";
}

function toggleStreetView(){
  streetVisible=!streetVisible;
  const div=document.getElementById("streetView");
  if(streetVisible){
    div.style.display="block";
    div.style.backgroundImage="url('street.jpg')";
  } else div.style.display="none";
}

map.on("click",e=>{
  if(marker) marker.setLatLng(e.latlng);
  else marker=L.marker(e.latlng).addTo(map);
});

async function loadPOIs(){
  poiLayer.clearLayers();
  const bbox = map.getBounds();
  const query = `[out:json][timeout:25];
    (
      node["amenity"="restaurant"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      node["amenity"="cafe"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      node["tourism"="museum"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      node["shop"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
    );
    out body;`;
  const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
  const res = await fetch(url);
  const data = await res.json();
  data.elements.forEach(e=>{
    if(e.lat && e.lon){
      const name = e.tags.name || (idioma==='es'?"Sin nombre":"Unnamed");
      const type = e.tags.amenity || e.tags.shop || e.tags.tourism || (idioma==='es'?"Lugar":"Place");
      L.marker([e.lat,e.lon]).addTo(poiLayer)
        .bindPopup(`<b>${name}</b><br>${type}`);
    }
  });
}
</script>

</body>
</html>
