<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Ikemap</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html,body{
  margin:0;
  height:100%;
  font-family:system-ui,-apple-system,Segoe UI
}
#map{height:100%}

/* BRAND */
.brand{
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  text-align:center;
  pointer-events:none
}
.brand h1{
  margin:0;
  font-size:28px;
  font-weight:700
}
.brand small{
  font-size:12px;
  color:#555
}

/* PANEL */
.panel{
  position:absolute;
  top:90px;
  left:12px;
  width:320px;
  background:white;
  padding:14px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
  z-index:1000
}
.panel input,.panel button{
  width:100%;
  padding:9px;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #ccc
}
.panel button{
  background:#007bff;
  color:white;
  border:none;
  font-weight:600;
  cursor:pointer
}
.panel button:hover{background:#005ec4}

.info{
  background:#f6f6f6;
  padding:8px;
  border-radius:8px;
  max-height:180px;
  overflow:auto;
  font-size:13px
}

/* TOP RIGHT */
.top-right{
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  display:flex;
  flex-direction:column;
  gap:6px
}
.top-right button{
  padding:7px 10px;
  border-radius:8px;
  border:none;
  background:#111;
  color:white;
  cursor:pointer
}

#profile{
  display:none;
  background:#f2f2f2;
  padding:8px;
  border-radius:10px;
  text-align:center
}
#profile img{
  width:42px;
  height:42px;
  border-radius:50%
}

.stars{color:#f5b301}

/* MOBILE */
@media(max-width:600px){
  .panel{width:90%;left:5%}
}
</style>
</head>
<body>

<div id="map"></div>

<div class="brand">
  <h1>Ikemap</h1>
  <small>© 2026 Iker’s Studio</small>
</div>

<div class="panel">
  <input id="from" placeholder="Desde">
  <input id="to" placeholder="Hasta">
  <button id="btn-route">Iniciar navegación</button>

  <button id="btn-poi">Mostrar lugares</button>
  <button id="btn-history">Historial</button>
  <button id="btn-reco">Recomendaciones</button>

  <div class="info" id="info">Indicaciones aparecerán aquí</div>
</div>

<div class="top-right">
  <button id="btn-lang">ES / EN</button>
  <button id="btn-login">Google</button>
  <div id="profile">
    <img id="pimg"><br>
    <span id="pname"></span>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyDiGY9FOUFwYYtyF9QGA53f4jh2rT1jab8",
  authDomain:"ikendo-49e0c.firebaseapp.com",
  databaseURL:"https://ikendo-49e0c-default-rtdb.firebaseio.com",
  projectId:"ikendo-49e0c"
});
const auth=firebase.auth();
const db=firebase.database();

/* MAP */
const map=L.map("map").setView([40.4168,-3.7038],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:19,
  attribution:"© OpenStreetMap"
}).addTo(map);

const poiLayer=L.layerGroup().addTo(map);
let routeLine;

/* LOGIN GOOGLE */
btn-login.onclick=()=>{
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
  .then(r=>{
    const u={
      uid:r.user.uid,
      name:r.user.displayName,
      photo:r.user.photoURL
    };
    localStorage.setItem("user",JSON.stringify(u));
    showProfile(u);
  });
};

function showProfile(u){
  profile.style.display="block";
  pname.textContent=u.name;
  pimg.src=u.photo;
}

const user=JSON.parse(localStorage.getItem("user"));
if(user)showProfile(user);

/* NAVIGATION (OSRM) */
btn-route.onclick=async()=>{
  if(routeLine)map.removeLayer(routeLine);

  const res=await fetch(
    "https://router.project-osrm.org/route/v1/driving/-3.7038,40.4168;-3.69,40.41?overview=full&steps=true"
  );
  const data=await res.json();

  const coords=data.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
  routeLine=L.polyline(coords,{color:"#007bff"}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  info.innerHTML="<b>Navegación:</b><br>";
  data.routes[0].legs[0].steps.forEach((s,i)=>{
    info.innerHTML+=`${i+1}. ${s.maneuver.instruction}<br>`;
  });
};

/* POIS */
async function loadPOIs(){
  poiLayer.clearLayers();
  const b=map.getBounds();
  const q=`[out:json];
  (node["amenity"~"restaurant|cafe|bar"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
   node["shop"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()}));out;`;

  const res=await fetch(
    "https://overpass-api.de/api/interpreter?data="+encodeURIComponent(q)
  );
  const data=await res.json();

  data.elements.forEach(e=>{
    if(!e.lat)return;
    const name=e.tags.name||"Lugar";

    const m=L.circleMarker([e.lat,e.lon],{
      radius:7,
      color:"#007bff",
      fillOpacity:.9
    }).addTo(poiLayer);

    m.bindTooltip(name);

    m.on("click",()=>{
      if(user){
        db.ref(`history/${user.uid}`).push({
          name,
          lat:e.lat,
          lon:e.lon,
          time:Date.now()
        });
      }
      if("Notification"in window && Notification.permission==="granted"){
        new Notification("Ikemap",{body:`Visitaste ${name}`});
      }
    });
  });
}

btn-poi.onclick=loadPOIs;

/* HISTORIAL */
btn-history.onclick=()=>{
  if(!user)return;
  info.innerHTML="<b>Historial:</b><br>";
  db.ref(`history/${user.uid}`).once("value",s=>{
    s.forEach(e=>{
      info.innerHTML+=`• ${e.val().name}<br>`;
    });
  });
};

/* RECOMENDACIONES */
btn-reco.onclick=()=>{
  info.innerHTML="<b>Recomendado para ti:</b><br>Restaurantes cercanos según tu historial";
};

/* NOTIFICATIONS */
if("Notification"in window){
  Notification.requestPermission();
}
</script>
</body>
</html>
