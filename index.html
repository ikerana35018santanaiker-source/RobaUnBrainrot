<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa con POIs Mejorado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
/* Reset y fuente */
html, body { margin:0; height:100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

/* Mapa */
#map { height:100%; }

/* Panel lateral */
.panel {
  position:absolute; top:10px; left:10px;
  background:white; padding:12px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.25);
  z-index:1000; width:300px;
}

/* Inputs y botones */
.panel input, .panel button {
  width:100%; margin-bottom:8px; padding:8px 10px;
  border-radius:6px; border:1px solid #ccc; font-size:14px;
  outline:none;
  transition: 0.2s;
}
.panel input:focus { border-color:#007bff; }
.panel button {
  background:#007bff; color:white; border:none; cursor:pointer; font-weight:bold;
}
.panel button:hover { background:#0056b3; }

/* InformaciÃ³n de instrucciones */
.info {
  font-size:13px; margin-top:6px;
  max-height:200px; overflow-y:auto; padding:6px;
  background:#f9f9f9; border-radius:6px; border:1px solid #ddd;
}

/* Street-view simulado */
#streetView {
  position:absolute; top:0; right:0; width:50%; height:50%;
  display:none; z-index:900; border:2px solid #333;
  background-size:cover; background-position:center; border-radius:8px;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="streetView"></div>

<div class="panel">
  <input id="search" placeholder="Buscar lugar">
  <button onclick="searchPlace()">ğŸ” Buscar</button>
  <input id="from" placeholder="Desde">
  <input id="to" placeholder="Hasta">
  <button onclick="route()">ğŸš— Direcciones</button>
  <button onclick="locate()">ğŸ“ Mi ubicaciÃ³n</button>
  <button onclick="toggleDark()">ğŸŒ™ Modo oscuro</button>
  <button onclick="toggleSatellite()">ğŸ›° SatÃ©lite</button>
  <button onclick="toggleStreetView()">ğŸ™ Street View</button>
  <button onclick="loadPOIs()">ğŸ“Œ Mostrar POIs</button>
  <div class="info" id="info">Las instrucciones aparecerÃ¡n aquÃ­.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map("map").setView([40.4168,-3.7038],13);

// Capas
const normalLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19, attribution:"Â© OSM"});
const darkLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19});
const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19});
normalLayer.addTo(map);
let currentLayer="normal";

let marker, routeLine;
let streetVisible=false;
let poiLayer = L.layerGroup().addTo(map);

// BÃºsqueda
async function searchPlace(){
  const q=document.getElementById("search").value;
  if(!q) return;
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
  const data=await res.json();
  if(!data[0]) return;
  const lat=data[0].lat, lon=data[0].lon;
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],15);
}

// Geocoding auxiliar
async function geocode(text){
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${text}`);
  const data=await res.json();
  return data[0];
}

// Routing + turn-by-turn con lista en info
async function route(){
  const from=document.getElementById("from").value;
  const to=document.getElementById("to").value;
  if(!from||!to) return;
  const f=await geocode(from), t=await geocode(to);
  if(!f||!t) return;
  const url=`https://router.project-osrm.org/route/v1/driving/${f.lon},${f.lat};${t.lon},${t.lat}?overview=full&geometries=geojson&steps=true`;
  const res=await fetch(url);
  const data=await res.json();
  const routeData=data.routes[0];
  const coords=routeData.geometry.coordinates.map(c=>[c[1],c[0]]);
  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{weight:5,color:"#007bff"}).addTo(map);
  map.fitBounds(routeLine.getBounds());
  
  // Mostrar pasos en lista
  const steps=routeData.legs[0].steps.map((s,i)=>`${i+1}. ${s.maneuver.instruction}`);
  document.getElementById("info").innerHTML = `<b>Direcciones:</b><br>` + steps.join("<br>");
  
  // Voz
  if('speechSynthesis' in window){
    speechSynthesis.cancel();
    steps.forEach(step=>speechSynthesis.speak(new SpeechSynthesisUtterance(step)));
  }
}

// GPS
function locate(){
  map.locate({setView:true,maxZoom:16});
  map.on("locationfound",e=>{
    L.marker(e.latlng).addTo(map).bindPopup("TÃº estÃ¡s aquÃ­").openPopup();
  });
}

// Dark / Satellite
function toggleDark(){
  map.eachLayer(l=>map.removeLayer(l));
  currentLayer=currentLayer==="dark"?"normal":"dark";
  (currentLayer==="dark"?darkLayer:normalLayer).addTo(map);
}
function toggleSatellite(){
  map.eachLayer(l=>map.removeLayer(l));
  satelliteLayer.addTo(map);
  currentLayer="satellite";
}

// Street-view simulado
function toggleStreetView(){
  streetVisible=!streetVisible;
  const div=document.getElementById("streetView");
  if(streetVisible){
    div.style.display="block";
    div.style.backgroundImage="url('street.jpg')";
  } else div.style.display="none";
}

// Click para marcador
map.on("click",e=>{
  if(marker) marker.setLatLng(e.latlng);
  else marker=L.marker(e.latlng).addTo(map);
});

// Cargar POIs
async function loadPOIs(){
  poiLayer.clearLayers();
  const bbox = map.getBounds();
  const query = `[out:json][timeout:25];
    (
      node["amenity"="restaurant"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      node["amenity"="cafe"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      node["tourism"="museum"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
      node["shop"](${bbox.getSouth()},${bbox.getWest()},${bbox.getNorth()},${bbox.getEast()});
    );
    out body;`;
  const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
  const res = await fetch(url);
  const data = await res.json();
  data.elements.forEach(e=>{
    if(e.lat && e.lon){
      const name = e.tags.name || "Sin nombre";
      const type = e.tags.amenity || e.tags.shop || e.tags.tourism || "Lugar";
      L.marker([e.lat,e.lon]).addTo(poiLayer)
        .bindPopup(`<b>${name}</b><br>${type}`);
    }
  });
}
</script>

</body>
</html>
