<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa Avanzado Offline</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
html,body { margin:0; height:100%; font-family:Arial,sans-serif; }
#map { height:100%; }
.panel {
  position:absolute; top:10px; left:10px;
  background:white; padding:10px; border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.3); z-index:1000; width:280px;
}
.panel input, .panel button { width:100%; margin-bottom:6px; padding:6px; }
.panel button { cursor:pointer; }
.info { font-size:13px; margin-top:4px; }
#streetView {
  position:absolute; top:0; right:0; width:50%; height:50%;
  display:none; z-index:900; border:2px solid #333;
  background-size:cover; background-position:center;
}
</style>
</head>
<body>

<div id="map"></div>
<div id="streetView"></div>

<div class="panel">
  <input id="search" placeholder="Buscar lugar">
  <button onclick="searchPlace()">ğŸ” Buscar</button>
  <input id="from" placeholder="Desde">
  <input id="to" placeholder="Hasta">
  <button onclick="route()">ğŸš— Direcciones</button>
  <button onclick="locate()">ğŸ“ Mi ubicaciÃ³n</button>
  <button onclick="toggleDark()">ğŸŒ™ Modo oscuro</button>
  <button onclick="toggleSatellite()">ğŸ›° SatÃ©lite</button>
  <button onclick="toggleStreetView()">ğŸ™ Street View</button>
  <div class="info" id="info"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

<script>
let map = L.map("map").setView([40.4168,-3.7038],13);

// Capas
const normalLayer = L.tileLayer("tiles/{z}/{x}/{y}.png",{maxZoom:19, attribution:"OSM"});
const darkLayer = L.tileLayer("tiles-dark/{z}/{x}/{y}.png",{maxZoom:19});
const satelliteLayer = L.tileLayer("tiles-sat/{z}/{x}/{y}.png",{maxZoom:19});
normalLayer.addTo(map);
let currentLayer="normal";

let marker, routeLine;
let streetVisible=false;

// Service Worker registro
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(e=>console.log("SW error", e));
}

// BÃºsqueda
async function searchPlace(){
  const q=document.getElementById("search").value;
  if(!q) return;
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
  const data=await res.json();
  if(!data[0]) return;
  const lat=data[0].lat, lon=data[0].lon;
  if(marker) map.removeLayer(marker);
  marker=L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],15);
}

// Geocoding auxiliar
async function geocode(text){
  const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${text}`);
  const data=await res.json();
  return data[0];
}

// Routing + turn-by-turn
async function route(){
  const from=document.getElementById("from").value;
  const to=document.getElementById("to").value;
  if(!from||!to) return;
  const f=await geocode(from), t=await geocode(to);
  if(!f||!t) return;
  const url=`https://router.project-osrm.org/route/v1/driving/${f.lon},${f.lat};${t.lon},${t.lat}?overview=full&geometries=geojson&steps=true`;
  const res=await fetch(url);
  const data=await res.json();
  const routeData=data.routes[0];
  const coords=routeData.geometry.coordinates.map(c=>[c[1],c[0]]);
  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{weight:5}).addTo(map);
  map.fitBounds(routeLine.getBounds());
  
  const steps=routeData.legs[0].steps.map(s=>s.maneuver.instruction);
  document.getElementById("info").innerHTML=steps.join("<br>");
  if('speechSynthesis' in window){
    speechSynthesis.cancel();
    steps.forEach(step=>speechSynthesis.speak(new SpeechSynthesisUtterance(step)));
  }
}

// GPS
function locate(){
  map.locate({setView:true,maxZoom:16});
  map.on("locationfound",e=>{
    L.marker(e.latlng).addTo(map).bindPopup("TÃº estÃ¡s aquÃ­").openPopup();
  });
}

// Dark / Satellite
function toggleDark(){
  map.eachLayer(l=>map.removeLayer(l));
  currentLayer=currentLayer==="dark"?"normal":"dark";
  (currentLayer==="dark"?darkLayer:normalLayer).addTo(map);
}
function toggleSatellite(){
  map.eachLayer(l=>map.removeLayer(l));
  satelliteLayer.addTo(map);
  currentLayer="satellite";
}

// Street-view simulado
function toggleStreetView(){
  streetVisible=!streetVisible;
  const div=document.getElementById("streetView");
  if(streetVisible){
    div.style.display="block";
    div.style.backgroundImage="url('street.jpg')";
  } else div.style.display="none";
}

// Click para marcador
map.on("click",e=>{
  if(marker) marker.setLatLng(e.latlng);
  else marker=L.marker(e.latlng).addTo(map);
});

// Edificios 3D (simulado con rectÃ¡ngulos extruidos)
const buildings=L.layerGroup().addTo(map);
function addBuilding(lat,lng,height){
  L.rectangle([[lat,lng],[lat+0.001,lng+0.001]],{color:"#666",weight:1,fillOpacity:0.5}).addTo(buildings);
}
addBuilding(40.417,-3.705,50);
addBuilding(40.418,-3.704,30);
</script>
</body>
</html>
